-- VERSION 0.1 TARTDATE:25/09/2014 ENDDATE:26/09/2014 ISSUE NO:88 COMMENT NO:1 DESC:SP FOR CALCULATE PERSENT,ABSENT,ONDUTY AND PERMISSION. DONE BY :RAJA
DROP PROCEDURE IF EXISTS SP_TS_ATTENDANCE_CALCULATION;
CREATE PROCEDURE SP_TS_ATTENDANCE_CALCULATION(
IN MONTH_YEAR VARCHAR(20),
IN LOGIN_ID VARCHAR(50),
IN USERSTAMP VARCHAR(50),
OUT TEMP_ATTENDANCE_CALCULATION TEXT,
OUT TOTAL_DAYS INT)
BEGIN
	DECLARE SHORTMONTH VARCHAR(10);
	DECLARE MONTH_STARTDATE DATE;
	DECLARE MONTH_ENDDATE DATE;
	DECLARE TEMP_ATTENDANCECALCULATION TEXT;
	DECLARE USERSTAMP_ID INT(11);
	DECLARE ULDID INT(11);
	DECLARE I INT(2);
	DECLARE T_PRESENT DECIMAL(3,1);
	DECLARE T_ABSENT DECIMAL(3,1);
	DECLARE T_ONDUTY DECIMAL(3,1);
	DECLARE T_PERMISSION DECIMAL(3,1);
  DECLARE TEMPATTENDANCE TEXT;
	DECLARE TEMP_ATTENDANCE TEXT;
	DECLARE TEMP_ATTENDANCECOUNT TEXT;
	DECLARE TEMP_ATTENDANCE_COUNT TEXT;
	DECLARE TEMP_USERSULDID TEXT;
	DECLARE TEMP_USERS_ULDID TEXT;
	DECLARE US_MIN_ID INT;
	DECLARE US_MAX_ID INT;
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
		ROLLBACK;
		IF(TEMP_ATTENDANCE_COUNT IS NOT NULL)THEN
			SET @DROP_TEMP_ATTENDANCE_COUNT = (SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_ATTENDANCE_COUNT));
			PREPARE DROP_TEMP_ATTENDANCE_COUNT_STMT FROM @DROP_TEMP_ATTENDANCE_COUNT;
			EXECUTE DROP_TEMP_ATTENDANCE_COUNT_STMT;
		END IF;
    IF(TEMP_ATTENDANCE IS NOT NULL)THEN
      SET @DROP_TEMP_ATTENDANCE = (SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_ATTENDANCE));
      PREPARE DROP_TEMP_ATTENDANCE_STMT FROM @DROP_TEMP_ATTENDANCE;
      EXECUTE DROP_TEMP_ATTENDANCE_STMT;
    END IF;
		IF(TEMP_USERS_ULDID IS NOT NULL)THEN
			SET @DROP_TEMP_USERS_ULDID = (SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_USERS_ULDID));
			PREPARE DROP_TEMP_USERS_ULDID_STMT FROM @DROP_TEMP_USERS_ULDID;
			EXECUTE DROP_TEMP_USERS_ULDID_STMT;
		END IF;
	END;
	START TRANSACTION;
	SET I=1;
	SET T_PRESENT=0;
	SET T_ABSENT=0;
	SET T_ONDUTY=0;
	SET T_PERMISSION=0;
	CALL SP_TS_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULD_ID);
	SET USERSTAMP_ID=@ULD_ID;  
	IF(LOGIN_ID='')THEN
		SET LOGIN_ID=NULL;
	END IF;

	SET SHORTMONTH=(SELECT SUBSTRING(MONTH_YEAR,1,3));
	SET MONTH_STARTDATE=(SELECT CONCAT(SUBSTRING_INDEX(MONTH_YEAR,'-',-1),'-',(MONTH(STR_TO_DATE(SHORTMONTH,'%b'))),'-01'));
	SET MONTH_ENDDATE=(SELECT LAST_DAY(MONTH_STARTDATE));

  SET TOTAL_DAYS=(SELECT DAY(LAST_DAY(MONTH_STARTDATE)));
	SELECT COUNT(ROW+1) AS SUNDAYS INTO @SUNDAYCOUNT FROM
	(SELECT @ROW := @ROW + 1 AS ROW FROM 
	(SELECT 0 UNION ALL SELECT 1 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6) T1,
	(SELECT 0 UNION ALL SELECT 1 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6) T2, 
	(SELECT @ROW:=-1) T3 LIMIT 31) B
	WHERE DATE_ADD(MONTH_STARTDATE, INTERVAL ROW DAY) BETWEEN MONTH_STARTDATE AND MONTH_ENDDATE AND DAYOFWEEK(DATE_ADD(MONTH_STARTDATE, INTERVAL ROW DAY))=1;
	SET TOTAL_DAYS=(TOTAL_DAYS-@SUNDAYCOUNT);
	SET TOTAL_DAYS=(TOTAL_DAYS-(SELECT COUNT(*) FROM PUBLIC_HOLIDAY WHERE PH_DATE BETWEEN MONTH_STARTDATE AND MONTH_ENDDATE));

	-- CALCULATE FOR SINGLE USER
	IF(LOGIN_ID IS NOT NULL)THEN    
		CALL SP_TS_CHANGE_USERSTAMP_AS_ULDID(LOGIN_ID,@ULD_ID);
		SET ULDID=@ULD_ID;
  	-- FOR TEMP TABLE FOR SINGLE ULDID
  	SET TEMPATTENDANCE=(SELECT CONCAT('TEMP_ATTENDANCE',SYSDATE()));
  	SET TEMPATTENDANCE=(SELECT REPLACE(TEMPATTENDANCE,':',''));
  	SET TEMPATTENDANCE=(SELECT REPLACE(TEMPATTENDANCE,'-',''));
  	SET TEMPATTENDANCE=(SELECT REPLACE(TEMPATTENDANCE,' ',''));
  	SET TEMP_ATTENDANCE=(SELECT CONCAT(TEMPATTENDANCE,'_',USERSTAMP_ID));  
  	SET @CREATE_TEMP_ATTENDANCE=(SELECT CONCAT('CREATE TABLE ',TEMP_ATTENDANCE,' (
  	ID INT NOT NULL AUTO_INCREMENT,
  	REPORT_DATE DATE,
  	PRESENT CHAR(20),
  	ABSENT CHAR(20),
    ONDUTY CHAR(20),
  	PERMISSION_HRS DECIMAL(3,1),
    PRIMARY KEY(ID))'));
  	PREPARE CREATE_TEMP_ATTENDANCE_STMT FROM @CREATE_TEMP_ATTENDANCE;
  	EXECUTE CREATE_TEMP_ATTENDANCE_STMT;
    -- FOR OUT TEMP TABLE FOR SINGLE ULDID
  	SET TEMP_ATTENDANCECALCULATION=(SELECT CONCAT('TEMP_ATTENDANCE_CALCULATION',SYSDATE()));
  	SET TEMP_ATTENDANCECALCULATION=(SELECT REPLACE(TEMP_ATTENDANCECALCULATION,':',''));
  	SET TEMP_ATTENDANCECALCULATION=(SELECT REPLACE(TEMP_ATTENDANCECALCULATION,'-',''));
  	SET TEMP_ATTENDANCECALCULATION=(SELECT REPLACE(TEMP_ATTENDANCECALCULATION,' ',''));
  	SET TEMP_ATTENDANCE_CALCULATION=(SELECT CONCAT(TEMP_ATTENDANCECALCULATION,'_',USERSTAMP_ID));  
  	SET @CREATE_TEMP_ATTENDANCE_CALCULATION=(SELECT CONCAT('CREATE TABLE ',TEMP_ATTENDANCE_CALCULATION,' (
  	ID INT NOT NULL AUTO_INCREMENT,
  	REPORT_DATE DATE,
  	PRESENT CHAR(20),
  	ABSENT CHAR(20),
    ONDUTY CHAR(20),
  	PERMISSION_HRS DECIMAL(3,1),
    PRIMARY KEY(ID))'));
  	PREPARE CREATE_TEMP_ATTENDANCE_CALCULATION_STMT FROM @CREATE_TEMP_ATTENDANCE_CALCULATION;
  	EXECUTE CREATE_TEMP_ATTENDANCE_CALCULATION_STMT;
		-- FOR TEMP TABLE
		SET TEMP_ATTENDANCECOUNT=(SELECT CONCAT('TEMP_ATTENDANCE_COUNT',SYSDATE()));
		SET TEMP_ATTENDANCECOUNT=(SELECT REPLACE(TEMP_ATTENDANCECOUNT,':',''));
		SET TEMP_ATTENDANCECOUNT=(SELECT REPLACE(TEMP_ATTENDANCECOUNT,'-',''));
		SET TEMP_ATTENDANCECOUNT=(SELECT REPLACE(TEMP_ATTENDANCECOUNT,' ',''));
		SET TEMP_ATTENDANCE_COUNT=(SELECT CONCAT(TEMP_ATTENDANCECOUNT,'_',USERSTAMP_ID));    
		SET @CREATE_TEMP_ATTENDANCE_COUNT=(SELECT CONCAT('CREATE TABLE ',TEMP_ATTENDANCE_COUNT,' (
		ID INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
		ULD_ID INT NOT NULL,
		PRESENT INT,
		ABSENT INT,
		ONDUTY INT,
		HALFDAY INT,
		HALFOD INT,
		PERMISSION INT)'));
		PREPARE CREATE_TEMP_ATTENDANCE_COUNT_STMT FROM @CREATE_TEMP_ATTENDANCE_COUNT;
		EXECUTE CREATE_TEMP_ATTENDANCE_COUNT_STMT;
		-- INSERT INTO TEMP TABLE
		SET @INSERT_TEMP_ATTENDANCE_COUNT=(SELECT CONCAT('INSERT INTO ',TEMP_ATTENDANCE_COUNT,'(ULD_ID,PRESENT,ABSENT,ONDUTY,HALFDAY,HALFOD,PERMISSION) VALUES
		((',ULDID,'),(SELECT COUNT(UARD_ATTENDANCE) FROM USER_ADMIN_REPORT_DETAILS WHERE ULD_ID=',ULDID,' AND UARD_DATE BETWEEN ','"',MONTH_STARTDATE,'"',' AND ','"',MONTH_ENDDATE,'"',' AND UARD_ATTENDANCE=5),
		(SELECT COUNT(UARD_ATTENDANCE) FROM USER_ADMIN_REPORT_DETAILS WHERE ULD_ID=',ULDID,' AND UARD_DATE BETWEEN ','"',MONTH_STARTDATE,'"',' AND ','"',MONTH_ENDDATE,'"',' AND UARD_ATTENDANCE=6),
		(SELECT COUNT(UARD_ATTENDANCE) FROM USER_ADMIN_REPORT_DETAILS WHERE ULD_ID=',ULDID,' AND UARD_DATE BETWEEN ','"',MONTH_STARTDATE,'"',' AND ','"',MONTH_ENDDATE,'"',' AND UARD_ATTENDANCE=7),
		(SELECT COUNT(UARD_ATTENDANCE) FROM USER_ADMIN_REPORT_DETAILS WHERE ULD_ID=',ULDID,' AND UARD_DATE BETWEEN ','"',MONTH_STARTDATE,'"',' AND ','"',MONTH_ENDDATE,'"',' AND UARD_ATTENDANCE=4 AND UARD_AM_SESSION IN (1,2) AND UARD_PM_SESSION IN (1,2)),
		(SELECT COUNT(UARD_ATTENDANCE) FROM USER_ADMIN_REPORT_DETAILS WHERE ULD_ID=',ULDID,' AND UARD_DATE BETWEEN ','"',MONTH_STARTDATE,'"',' AND ','"',MONTH_ENDDATE,'"',' AND UARD_ATTENDANCE=8 AND UARD_AM_SESSION IN (1,2) AND UARD_PM_SESSION IN (1,2)),
		(SELECT COUNT(UARD_PERMISSION) FROM USER_ADMIN_REPORT_DETAILS WHERE ULD_ID=',ULDID,' AND UARD_DATE BETWEEN ','"',MONTH_STARTDATE,'"',' AND ','"',MONTH_ENDDATE,'"','))'));
		PREPARE INSERT_TEMP_ATTENDANCE_COUNT_STMT FROM @INSERT_TEMP_ATTENDANCE_COUNT;
		EXECUTE INSERT_TEMP_ATTENDANCE_COUNT_STMT;

		SET @PRESENT_COUNT=(SELECT CONCAT('SELECT PRESENT,ABSENT,ONDUTY,HALFDAY,HALFOD,PERMISSION INTO @PRSNT,@ABSNT,@OD,@HALFDAYLEAVE,@HALFDAYOD,@PERMSN FROM ',TEMP_ATTENDANCE_COUNT));
		PREPARE PRESENT_COUNT_STMT FROM @PRESENT_COUNT;
		EXECUTE PRESENT_COUNT_STMT;
    SET @AM_PM_ABSENT=(SELECT CONCAT('SELECT UARD_AM_SESSION,UARD_PM_SESSION INTO @AM,@PM FROM USER_ADMIN_REPORT_DETAILS WHERE ULD_ID=',ULDID,' AND UARD_DATE BETWEEN ','"',MONTH_STARTDATE,'"',' AND ','"',MONTH_ENDDATE,'"',' AND UARD_ATTENDANCE=4 AND UARD_AM_SESSION IN (1,2) AND UARD_PM_SESSION IN (1,2)'));
    PREPARE AM_PM_ABSENT_STMT FROM @AM_PM_ABSENT;
		EXECUTE AM_PM_ABSENT_STMT;
		SET @AM_PM_ABSENT=(SELECT CONCAT('SELECT UARD_AM_SESSION,UARD_PM_SESSION INTO @AM_OD,@PM_OD FROM USER_ADMIN_REPORT_DETAILS WHERE ULD_ID=',ULDID,' AND UARD_DATE BETWEEN ','"',MONTH_STARTDATE,'"',' AND ','"',MONTH_ENDDATE,'"',' AND UARD_ATTENDANCE=8 AND UARD_AM_SESSION IN (1,2) AND UARD_PM_SESSION IN (1,2)'));
    PREPARE AM_PM_ABSENT_STMT FROM @AM_PM_ABSENT;
		EXECUTE AM_PM_ABSENT_STMT;
    IF(@PRSNT!=0)THEN
			SET @INSERT_TEMP_ATTENDANCE=(SELECT CONCAT('INSERT INTO ',TEMP_ATTENDANCE,'(REPORT_DATE,PRESENT)  
      (SELECT UARD_DATE,"X" FROM USER_ADMIN_REPORT_DETAILS WHERE ULD_ID=',ULDID,' AND UARD_DATE BETWEEN ','"',MONTH_STARTDATE,'"',' AND ','"',MONTH_ENDDATE,'"',' AND UARD_ATTENDANCE=5)'));
  		PREPARE INSERT_TEMP_ATTENDANCE_STMT FROM @INSERT_TEMP_ATTENDANCE;
  		EXECUTE INSERT_TEMP_ATTENDANCE_STMT;
		END IF;
    IF(@ABSNT!=0)THEN
			SET @INSERT_TEMP_ATTENDANCE=(SELECT CONCAT('INSERT INTO ',TEMP_ATTENDANCE,'(REPORT_DATE,ABSENT)
  		(SELECT UARD_DATE,"X" FROM USER_ADMIN_REPORT_DETAILS WHERE ULD_ID=',ULDID,' AND UARD_DATE BETWEEN ','"',MONTH_STARTDATE,'"',' AND ','"',MONTH_ENDDATE,'"',' AND UARD_ATTENDANCE=6)'));
  		PREPARE INSERT_TEMP_ATTENDANCE_STMT FROM @INSERT_TEMP_ATTENDANCE;
  		EXECUTE INSERT_TEMP_ATTENDANCE_STMT;
		END IF;
    IF(@OD!=0)THEN
			SET @INSERT_TEMP_ATTENDANCE=(SELECT CONCAT('INSERT INTO ',TEMP_ATTENDANCE,'(REPORT_DATE,ONDUTY)
  		(SELECT UARD_DATE,"X" FROM USER_ADMIN_REPORT_DETAILS WHERE ULD_ID=',ULDID,' AND UARD_DATE BETWEEN ','"',MONTH_STARTDATE,'"',' AND ','"',MONTH_ENDDATE,'"',' AND UARD_ATTENDANCE=7)'));
  		PREPARE INSERT_TEMP_ATTENDANCE_STMT FROM @INSERT_TEMP_ATTENDANCE;
  		EXECUTE INSERT_TEMP_ATTENDANCE_STMT;
		END IF;
		IF(@HALFDAYLEAVE!=0)THEN
      IF(@AM=1 AND @PM=2)THEN
  		  SET @INSERT_TEMP_ATTENDANCE=(SELECT CONCAT('INSERT INTO ',TEMP_ATTENDANCE,'(REPORT_DATE,PRESENT,ABSENT)
    		(SELECT UARD_DATE,"MORNING PRESENT","AFTERNOON ABSENT" FROM USER_ADMIN_REPORT_DETAILS WHERE ULD_ID=',ULDID,' AND UARD_DATE BETWEEN ','"',MONTH_STARTDATE,'"',' AND ','"',MONTH_ENDDATE,'"',' AND UARD_ATTENDANCE=4)'));
    		PREPARE INSERT_TEMP_ATTENDANCE_STMT FROM @INSERT_TEMP_ATTENDANCE;
    		EXECUTE INSERT_TEMP_ATTENDANCE_STMT;
      ELSEIF(@AM=2 AND @PM=1)THEN
        SET @INSERT_TEMP_ATTENDANCE=(SELECT CONCAT('INSERT INTO ',TEMP_ATTENDANCE,'(REPORT_DATE,PRESENT,ABSENT)
    		(SELECT UARD_DATE,"AFTERNOON PRESENT","MORNING ABSENT" FROM USER_ADMIN_REPORT_DETAILS WHERE ULD_ID=',ULDID,' AND UARD_DATE BETWEEN ','"',MONTH_STARTDATE,'"',' AND ','"',MONTH_ENDDATE,'"',' AND UARD_ATTENDANCE=4)'));
    		PREPARE INSERT_TEMP_ATTENDANCE_STMT FROM @INSERT_TEMP_ATTENDANCE;
    		EXECUTE INSERT_TEMP_ATTENDANCE_STMT;
      END IF;
		END IF;
		IF(@HALFDAYOD!=0)THEN
      IF(@AM_OD=1 AND @PM_OD=2)THEN
  			SET @INSERT_TEMP_ATTENDANCE=(SELECT CONCAT('INSERT INTO ',TEMP_ATTENDANCE,'(REPORT_DATE,PRESENT,ONDUTY)
    		(SELECT UARD_DATE,"MORNING PRESENT","AFTERNOON ONDUTY" FROM USER_ADMIN_REPORT_DETAILS WHERE ULD_ID=',ULDID,' AND UARD_DATE BETWEEN ','"',MONTH_STARTDATE,'"',' AND ','"',MONTH_ENDDATE,'"',' AND UARD_ATTENDANCE=8)'));
    		PREPARE INSERT_TEMP_ATTENDANCE_STMT FROM @INSERT_TEMP_ATTENDANCE;
    		EXECUTE INSERT_TEMP_ATTENDANCE_STMT;
      ELSEIF(@AM_OD=2 AND @PM_OD=1)THEN
        SET @INSERT_TEMP_ATTENDANCE=(SELECT CONCAT('INSERT INTO ',TEMP_ATTENDANCE,'(REPORT_DATE,PRESENT,ONDUTY)
    		(SELECT UARD_DATE,"AFTERNOON PRESENT","MORNING ONDUTY" FROM USER_ADMIN_REPORT_DETAILS WHERE ULD_ID=',ULDID,' AND UARD_DATE BETWEEN ','"',MONTH_STARTDATE,'"',' AND ','"',MONTH_ENDDATE,'"',' AND UARD_ATTENDANCE=8)'));
    		PREPARE INSERT_TEMP_ATTENDANCE_STMT FROM @INSERT_TEMP_ATTENDANCE;
    		EXECUTE INSERT_TEMP_ATTENDANCE_STMT;
      END IF;
		END IF;
		IF(@PERMSN!=0)THEN  	      
      SET @UPDATE_TEMP_ATTENDANCE=(SELECT CONCAT('UPDATE ',TEMP_ATTENDANCE,' X 
      INNER JOIN (SELECT UARD.UARD_DATE,AC.AC_DATA FROM USER_ADMIN_REPORT_DETAILS UARD,ATTENDANCE_CONFIGURATION AC 
  		WHERE UARD.ULD_ID=',ULDID,' AND UARD.UARD_DATE BETWEEN ','"',MONTH_STARTDATE,'"',' AND ','"',MONTH_ENDDATE,'"',' 
      AND UARD.UARD_PERMISSION IS NOT NULL AND UARD.UARD_PERMISSION=AC.AC_ID) Y ON X.REPORT_DATE=Y.UARD_DATE SET X.PERMISSION_HRS=Y.AC_DATA'));
  		PREPARE UPDATE_TEMP_ATTENDANCE_STMT FROM @UPDATE_TEMP_ATTENDANCE;
  		EXECUTE UPDATE_TEMP_ATTENDANCE_STMT;			
		END IF;

		-- INSERT INTO MAIN TEMP TABLE
		SET @INSERT_TEMP_ATTENDANCE_CALCULATION=(SELECT CONCAT('INSERT INTO ',TEMP_ATTENDANCE_CALCULATION,' (REPORT_DATE,PRESENT,ABSENT,ONDUTY,PERMISSION_HRS)
    SELECT REPORT_DATE,PRESENT,ABSENT,ONDUTY,PERMISSION_HRS FROM ',TEMP_ATTENDANCE,' ORDER BY REPORT_DATE'));
		PREPARE INSERT_TEMP_ATTENDANCE_CALCULATION_STMT FROM @INSERT_TEMP_ATTENDANCE_CALCULATION;
		EXECUTE INSERT_TEMP_ATTENDANCE_CALCULATION_STMT;
    SET @DROP_TEMP_ATTENDANCE = (SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_ATTENDANCE));
		PREPARE DROP_TEMP_ATTENDANCE_STMT FROM @DROP_TEMP_ATTENDANCE;
		EXECUTE DROP_TEMP_ATTENDANCE_STMT;
		SET @DROP_TEMP_ATTENDANCE_COUNT = (SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_ATTENDANCE_COUNT));
		PREPARE DROP_TEMP_ATTENDANCE_COUNT_STMT FROM @DROP_TEMP_ATTENDANCE_COUNT;
		EXECUTE DROP_TEMP_ATTENDANCE_COUNT_STMT;		
	END IF;
	COMMIT;
END;
/*
CALL SP_TS_ATTENDANCE_CALCULATION('july-2014','dhandapani.sattanathan@ssomens.com','dhandapani.sattanathan@ssomens.com',@TEMP_ATTENDANCE_CALCULATION,@TOTAL_DAYS);
SELECT @TOTAL_DAYS;
*/