--version 0.8 --sdate:28/02/2014 --edate:28/02/2014 --issue:754 --comment:22 --doneby:RL	
--version 0.7 --sdate:27/02/2014 --edate:27/02/2014 --issue:754 --comment:22 --doneby:RL
--version 0.6-->startdate:17/02/2013 enddate:17/02/2013 -->issue no:749 comment no:#15 desc:implement flag in SP_EMAIL_TEMPLATE_INSERT done by:BHAVANI.R
--version 0.5-->startdate:17/02/2013 enddate:17/02/2013 -->issue no:749 comment no:#4 desc:implement flag in SP_EMAIL_TEMPLATE_INSERT done by:BHAVANI.R
--version 0.4-->startdate:09/11/2013 enddate:09/11/2013 -->issue no:636 comment no:#47 desc:changed sp name and file name done by:DHIVYA.A
--> version 0.3 -->startdate:11/10/2013  enddate:11/10/2013-->issueno:636 -->desc:added comments
-->doneby:DHIVYA.A
--> version 0.2 -->startdate:26/08/2013  enddate:26/08/2013-->issueno:599  comment no=#2-->desc:implemented rollback and commit concept
-->doneby:DHIVYA.A
--> version 0.1 -->startdate:24/08/2013  enddate:26/08/2013-->issueno:599 -->desc:sp for email_template form
-->doneby:DHIVYA.A


DROP PROCEDURE IF EXISTS SP_EMAIL_TEMPLATE_INSERT;
CREATE PROCEDURE SP_EMAIL_TEMPLATE_INSERT(
IN EMAIL_SCRIPT VARCHAR(100),
IN EMAIL_SUBJECT VARCHAR(1000),
IN EMAIL_BODY VARCHAR(1000),
IN USERSTAMP VARCHAR(50),
OUT FLAG INTEGER)
BEGIN
DECLARE USERSTAMP_ID INTEGER(2);
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK;
END;
START TRANSACTION;
SET FLAG = 0;
CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
SET USERSTAMP_ID = (SELECT @ULDID);
IF (EMAIL_SCRIPT IS NOT NULL AND EMAIL_SUBJECT IS NOT NULL AND EMAIL_BODY IS NOT NULL AND USERSTAMP IS NOT NULL)THEN
-- condition for checking the passing email_script is not in the EMAIL_TEMPLATE table
IF NOT EXISTS(SELECT ET_EMAIL_SCRIPT FROM EMAIL_TEMPLATE WHERE ET_EMAIL_SCRIPT=EMAIL_SCRIPT)THEN
-- insert query for EMAIL_TEMPLATE table
INSERT INTO EMAIL_TEMPLATE(ET_EMAIL_SCRIPT)VALUES(EMAIL_SCRIPT);
set flag=1;
END IF;
IF NOT EXISTS(SELECT ET_ID FROM EMAIL_TEMPLATE_DETAILS WHERE ET_ID=(SELECT ET_ID FROM EMAIL_TEMPLATE WHERE ET_EMAIL_SCRIPT=EMAIL_SCRIPT))THEN
-- insert query for EMAIL_TEMPLATE_DETAILS table
INSERT INTO EMAIL_TEMPLATE_DETAILS(ET_ID,ETD_EMAIL_SUBJECT,ETD_EMAIL_BODY,ULD_ID)VALUES((SELECT ET_ID FROM EMAIL_TEMPLATE WHERE ET_EMAIL_SCRIPT=EMAIL_SCRIPT),EMAIL_SUBJECT,EMAIL_BODY,USERSTAMP_ID);
set flag=1;
END IF;
END IF;
COMMIT;
END;