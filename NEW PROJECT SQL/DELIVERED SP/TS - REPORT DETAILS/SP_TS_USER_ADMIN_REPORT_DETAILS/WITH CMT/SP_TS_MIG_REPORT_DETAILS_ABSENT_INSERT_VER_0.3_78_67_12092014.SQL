-- VERSION 0.3 STARTDATE:12/09/2014 ENDDATE:12/09/2014 ISSUE NO:78 COMMENT NO :67 DESC:MODIFIED THE USER ADMIN REPORT TABLE FOR THE NEW MIG REPORT. DONE BY :RAJA
-- VERSION 0.2 STARTDATE:05/08/2014 ENDDATE:06/08/2014 ISSUE NO:78 COMMENT NO :45 DESC:ADDED NEW KEY WORDS FOR THE NEW MIG REPORT. DONE BY :RAJA
-- VERSION 0.1 STARTDATE:22/08/2014 ENDDATE:24/08/2014 ISSUE NO:78 COMMENT NO :33 DESC:SP FOR CREATE THE USER_ADMIN_REPORT_DETAILS AND INSERT THE ABSENTIES REPORTS. DONE BY :RAJA
DROP PROCEDURE IF EXISTS SP_TS_MIG_REPORT_DETAILS_ABSENT_INSERT;
CREATE PROCEDURE SP_TS_MIG_REPORT_DETAILS_ABSENT_INSERT(
IN SOURCESCHEMA VARCHAR(40),
IN DESTINATIONSCHEMA VARCHAR(40),
IN MIGUSERSTAMP VARCHAR(50))
BEGIN
	DECLARE ABS_TIMESTAMP TIMESTAMP; 
	DECLARE ABS_USERSTAMP VARCHAR(50); 
	DECLARE PDMAX_ID INT;
	DECLARE UARDMAX_ID INT;
	DECLARE ABS_MIN_ID INT;
	DECLARE ABS_MAX_ID INT;
	DECLARE START_TIME TIME;
	DECLARE END_TIME TIME;
	DECLARE DURATION TIME;
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
		ROLLBACK;
	END;
	START TRANSACTION;
	SET @LOGIN_ID=(SELECT CONCAT('SELECT ULD_ID INTO @ULDID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=','"',MIGUSERSTAMP,'"'));
	PREPARE LOGINID_STMT FROM @LOGIN_ID;
	EXECUTE LOGINID_STMT;
	-- TEMP SOURCE TABLE IN DEST
	SET @DROP_TEMP_REPORTSSCDBFORMAT=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_REPORTS_SCDB_FORMAT'));
	PREPARE DROP_TEMP_REPORTS_SCDB_FORMAT_STMT FROM @DROP_TEMP_REPORTSSCDBFORMAT;
	EXECUTE DROP_TEMP_REPORTS_SCDB_FORMAT_STMT;
	SET @CREATE_TEMP_REPORTSSCDBFORMAT=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.TEMP_REPORTS_SCDB_FORMAT(
	UID INT(11) NOT NULL AUTO_INCREMENT PRIMARY KEY,
	SILOID VARCHAR(255) DEFAULT NULL,
	TIMESTAMP VARCHAR(255) DEFAULT NULL,
	UNAME VARCHAR(255) DEFAULT NULL,
	UDATE VARCHAR(255) DEFAULT NULL,
	UREPORT TEXT,
	USERSTAMP VARCHAR(255) DEFAULT NULL)'));
	PREPARE CREATE_TEMP_REPORTS_SCDB_FORMAT_STMT FROM @CREATE_TEMP_REPORTSSCDBFORMAT;
	EXECUTE CREATE_TEMP_REPORTS_SCDB_FORMAT_STMT;
	SET @INSERT_TEMP_REPORTSSCDBFORMAT=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.TEMP_REPORTS_SCDB_FORMAT(SILOID,TIMESTAMP,UNAME,UDATE,UREPORT,USERSTAMP) 
	(SELECT SILOID,TIMESTAMP,UNAME,UDATE,UREPORT,USERSTAMP FROM ',SOURCESCHEMA,'.REPORTS_SCDB_FORMAT)'));
	PREPARE INSERT_TEMP_REPORTS_SCDB_FORMAT_STMT FROM @INSERT_TEMP_REPORTSSCDBFORMAT;
	EXECUTE INSERT_TEMP_REPORTS_SCDB_FORMAT_STMT;
	SET @UPDATE_TEMP_REPORTSSCDBFORMAT=(SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_REPORTS_SCDB_FORMAT SET UNAME="bhavani.rajagopal@ssomens.com",USERSTAMP="bhavani.rajagopal@ssomens.com" WHERE UNAME="bhavani.rajagopalagopal@ssomens.com"'));
	PREPARE UPDATE_TEMP_REPORTS_SCDB_FORMAT_STMT FROM @UPDATE_TEMP_REPORTSSCDBFORMAT;
	EXECUTE UPDATE_TEMP_REPORTS_SCDB_FORMAT_STMT;
  
	-- TABLE FOR PROJECT DETAILS
	SET START_TIME = (SELECT CURTIME());
	SET @DROP_PROJECTDTLS=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.PROJECT_DETAILS'));
	PREPARE DROP_PROJECT_DETAILS_STMT FROM @DROP_PROJECTDTLS;
	EXECUTE DROP_PROJECT_DETAILS_STMT;    
	SET @CREATE_PROJECT_DETAILS=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.PROJECT_DETAILS(
	PD_ID	INTEGER	NOT NULL AUTO_INCREMENT,
	PD_PROJECT_NAME	VARCHAR(50)	NOT NULL,
	PD_PROJECT_DESCRIPTION	VARCHAR(100)	NOT NULL,
	ULD_ID INTEGER(2)	NOT NULL,
	PD_TIMESTAMP TIMESTAMP	NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY (PD_ID),
	UNIQUE (PD_PROJECT_NAME),
	FOREIGN KEY(ULD_ID) REFERENCES ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS (ULD_ID))'));
	PREPARE CREATE_PROJECT_DETAILS_STMT FROM @CREATE_PROJECT_DETAILS;
	EXECUTE CREATE_PROJECT_DETAILS_STMT;
	SET @INSERT_PROJECTDTLS=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.PROJECT_DETAILS(PD_PROJECT_NAME,PD_PROJECT_DESCRIPTION,ULD_ID,PD_TIMESTAMP) 
	(SELECT UCASE(CSQL.PD_DATA),UCASE(CSQL.PD_DESCRIPTION),ULD.ULD_ID,CSQL.TIMESTAMP FROM ',SOURCESCHEMA,'.CONFIG_SQL_FORMAT CSQL,',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS ULD WHERE CSQL.PD_DATA IS NOT NULL AND ULD.ULD_LOGINID=CSQL.USER_STAMP)'));
	PREPARE INSERT_PROJECT_DETAILS_STMT FROM @INSERT_PROJECTDTLS;
	EXECUTE INSERT_PROJECT_DETAILS_STMT;

	-- QUERY FOR ALTER AUTO_INCREMENT 
	SET @PDMAXID = (SELECT CONCAT('SELECT MAX(PD_ID) INTO @PD_MAX_ID FROM ',DESTINATIONSCHEMA,'.PROJECT_DETAILS'));
	PREPARE PD_MAX_ID_STMT FROM @PDMAXID;
	EXECUTE PD_MAX_ID_STMT;
	SET PDMAX_ID=@PD_MAX_ID;
	IF (PDMAX_ID IS NOT NULL) THEN    
		SET @ALTER_PROJECT_DETAILS =(SELECT CONCAT('ALTER TABLE ',DESTINATIONSCHEMA,'.PROJECT_DETAILS AUTO_INCREMENT=',PDMAX_ID));
		PREPARE ALTER_PROJECT_DETAILS_STMT FROM @ALTER_PROJECT_DETAILS;
		EXECUTE ALTER_PROJECT_DETAILS_STMT;
	END IF;
	SET END_TIME = (SELECT CURTIME());
	SET DURATION=(SELECT TIMEDIFF(END_TIME,START_TIME));

	-- QUERY FOR GET VALUES TO POST_AUDIT_HISTORY
	SET @COUNTPROJECTCONFIGSQLFOMAT=(SELECT CONCAT('SELECT COUNT(PD_DATA) INTO @COUNT_PROJECT_DETAILS_SQL_FORMAT FROM ',SOURCESCHEMA,'.CONFIG_SQL_FORMAT WHERE PD_DATA IS NOT NULL'));
	PREPARE COUNTPROJECTCONFIGSQLFOMATSTMT FROM @COUNTPROJECTCONFIGSQLFOMAT;
	EXECUTE COUNTPROJECTCONFIGSQLFOMATSTMT;
	SET @COUNTSPLITINGPROJECTDETAILS=(SELECT CONCAT('SELECT COUNT(*) INTO @COUNT_SPLITING_PROJECT_DETAILS FROM ',DESTINATIONSCHEMA,'.PROJECT_DETAILS'));
	PREPARE COUNTSPLITINGPROJECTDETAILSSTMT FROM @COUNTSPLITINGPROJECTDETAILS;
	EXECUTE COUNTSPLITINGPROJECTDETAILSSTMT;
	SET @REJECTION_COUNT=(@COUNT_PROJECT_DETAILS_SQL_FORMAT-@COUNT_SPLITING_PROJECT_DETAILS);
	SET @POSTAPID= (SELECT POSTAP_ID FROM POST_AUDIT_PROFILE WHERE POSTAP_DATA='PROJECT_DETAILS');
	SET @PREASPID = (SELECT PREASP_ID FROM PRE_AUDIT_SUB_PROFILE WHERE PREASP_DATA='PROJECT_DETAILS');
	SET @PREAMPID = (SELECT PREAMP_ID FROM PRE_AUDIT_MAIN_PROFILE WHERE PREAMP_DATA='REPORT');
	SET @DUR=DURATION;
	UPDATE PRE_AUDIT_SUB_PROFILE SET PREASP_NO_OF_REC=@COUNT_PROJECT_DETAILS_SQL_FORMAT WHERE PREASP_DATA='PROJECT_DETAILS';    
	INSERT INTO POST_AUDIT_HISTORY(POSTAP_ID,POSTAH_NO_OF_REC,PREASP_ID,PREAMP_ID,POSTAH_DURATION,POSTAH_NO_OF_REJ,ULD_ID)VALUES
	(@POSTAPID,@COUNT_SPLITING_PROJECT_DETAILS,@PREASPID,@PREAMPID,@DUR,@REJECTION_COUNT,@ULDID);

	-- TABLE FOR USER ADMIN REPORT DETAILS
	SET START_TIME = (SELECT CURTIME());
	SET @DROP_USERADMINREPORTDETAILS=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.USER_ADMIN_REPORT_DETAILS'));
	PREPARE DROP_USER_ADMIN_REPORT_DETAILS_STMT FROM @DROP_USERADMINREPORTDETAILS;
	EXECUTE DROP_USER_ADMIN_REPORT_DETAILS_STMT;
	SET @CREATE_USERADMINREPORTDETAILS=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.USER_ADMIN_REPORT_DETAILS(
	UARD_ID	INTEGER	NOT NULL AUTO_INCREMENT,
	UARD_REPORT	TEXT NULL,
	UARD_REASON	TEXT NULL,
	UARD_DATE	DATE NOT NULL,
	URC_ID INTEGER(2) NOT NULL,
	ULD_ID INTEGER(2) NOT NULL,
	UARD_PERMISSION	INTEGER	NULL,
	UARD_ATTENDANCE	INTEGER	NOT NULL,
	UARD_PDID	TEXT NULL,
	UARD_AM_SESSION	INTEGER NOT NULL,
	UARD_PM_SESSION	INTEGER	NOT NULL,
	UARD_BANDWIDTH DECIMAL(6,2) NOT NULL,
	UARD_USERSTAMP_ID	INTEGER	NOT NULL,
	UARD_TIMESTAMP TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  ABSENT_FLAG	CHAR(1) NULL,
	PRIMARY KEY(UARD_ID),
	FOREIGN KEY(URC_ID) REFERENCES ',DESTINATIONSCHEMA,'.CONFIGURATION (CGN_ID),
	FOREIGN KEY(ULD_ID) REFERENCES ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS (ULD_ID),
	FOREIGN KEY(UARD_USERSTAMP_ID) REFERENCES ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS (ULD_ID))'));
	PREPARE CREATE_USER_ADMIN_REPORT_DETAILS_STMT FROM @CREATE_USERADMINREPORTDETAILS;
	EXECUTE CREATE_USER_ADMIN_REPORT_DETAILS_STMT;       
  
	--  TEMP TABLE NAME TEMP_USER_ADMIN_REPORT_DETAILS
	SET @DROP_TEMP_USERADMINREPORTDETAILS=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_USER_ADMIN_REPORT_DETAILS'));
	PREPARE DROP_TEMP_USER_ADMIN_REPORT_DETAILS_STMT FROM @DROP_TEMP_USERADMINREPORTDETAILS;
	EXECUTE DROP_TEMP_USER_ADMIN_REPORT_DETAILS_STMT;
	SET @CREATE_TEMP_USERADMINREPORTDETAILS=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.TEMP_USER_ADMIN_REPORT_DETAILS(
	UARD_ID	INTEGER	NOT NULL AUTO_INCREMENT,
	UARD_REPORT	TEXT NULL,
	UARD_REASON	TEXT NULL,
	UARD_DATE	DATE NOT NULL,
	URC_ID INTEGER(2) NOT NULL,
	ULD_ID INTEGER(2) NOT NULL,
	UARD_PERMISSION	INTEGER	NULL,
	UARD_ATTENDANCE	INTEGER	NOT NULL,
	UARD_PDID	TEXT NULL,
	UARD_AM_SESSION	INTEGER NOT NULL,
	UARD_PM_SESSION	INTEGER	NOT NULL,
	UARD_BANDWIDTH DECIMAL(6,2) NOT NULL,
	UARD_USERSTAMP_ID	INTEGER	NOT NULL,
	UARD_TIMESTAMP TIMESTAMP	NOT NULL,
  ABSENT_FLAG	CHAR(1) NULL,
	PRIMARY KEY(UARD_ID),
	FOREIGN KEY(URC_ID) REFERENCES ',DESTINATIONSCHEMA,'.CONFIGURATION (CGN_ID),
	FOREIGN KEY(ULD_ID) REFERENCES ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS (ULD_ID),
	FOREIGN KEY(UARD_USERSTAMP_ID) REFERENCES ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS (ULD_ID))'));
	PREPARE CREATE_TEMP_USER_ADMIN_REPORT_DETAILS_STMT FROM @CREATE_TEMP_USERADMINREPORTDETAILS;
	EXECUTE CREATE_TEMP_USER_ADMIN_REPORT_DETAILS_STMT;

	-- TEMP TABLE FOR ABSENTIES
	SET @DROP_TEMP_ABSENT=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_ABSENT'));
	PREPARE DROP_TEMP_ABSENT_STMT FROM @DROP_TEMP_ABSENT;
	EXECUTE DROP_TEMP_ABSENT_STMT;
	SET @CREATE_TEMP_ABSENT=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.TEMP_ABSENT(
	ID INTEGER NOT NULL AUTO_INCREMENT PRIMARY KEY,
	UID INT(11) NOT NULL ,
	UNAME VARCHAR(255) DEFAULT NULL,
	UDATE VARCHAR(255) DEFAULT NULL,
	UREPORT TEXT,
	USERSTAMP VARCHAR(255) DEFAULT NULL,
	TIMESTAMP VARCHAR(255) DEFAULT NULL)'));
	PREPARE CREATE_TEMP_ABSENT_STMT FROM @CREATE_TEMP_ABSENT;
	EXECUTE CREATE_TEMP_ABSENT_STMT;
	SET @INSERT_TEMPABSENT=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.TEMP_ABSENT(UID,UNAME,UDATE,UREPORT,USERSTAMP,TIMESTAMP) 
	(SELECT UID,UNAME,UDATE,UREPORT,USERSTAMP,TIMESTAMP FROM ',DESTINATIONSCHEMA,'.TEMP_REPORTS_SCDB_FORMAT WHERE (UREPORT NOT LIKE "%Ha%day%Absent%" AND UREPORT NOT LIKE "%Absent not%"
	AND UREPORT NOT LIKE "%ABSENT record del%" AND UREPORT NOT LIKE "%AFT%ABSENT%" AND UREPORT NOT LIKE "%present%absent%" AND UREPORT NOT LIKE "%absentee%" AND UREPORT NOT LIKE "%0.5%D%"  
	AND UREPORT NOT LIKE "%ABSENT MAIL%" AND UREPORT NOT LIKE "%absent trigger%" AND UREPORT NOT LIKE "%Absent Radio%" AND UREPORT NOT LIKE "%Absent option%" AND UREPORT NOT LIKE "%Absent in%" 
	AND UREPORT NOT LIKE "%Absent for%" AND UREPORT NOT LIKE "%ABSENT MAIL%" AND UREPORT NOT LIKE "%ABSENT(AFTERNOON)%" AND UREPORT NOT LIKE "%ABSENT record%" AND UREPORT NOT LIKE "%ABSENT%ON%DUTY%"
	AND UREPORT NOT LIKE "%morning%Absent%" AND UREPORT NOT LIKE "%ABSENT: (half%") AND UREPORT NOT LIKE "%testing onduty%absent%halfday%" AND (UREPORT LIKE "%went chennai%" OR UREPORT LIKE "off%" 
	OR UREPORT LIKE "on leave%" OR UREPORT LIKE "%took leave%" OR UREPORT LIKE "%ABSENT%" OR UREPORT LIKE "%today%leave%" OR UREPORT LIKE "leave%"))'));
	PREPARE INSERT_TEMP_ABSENT_STMT FROM @INSERT_TEMPABSENT;
	EXECUTE INSERT_TEMP_ABSENT_STMT;  
	SET @DELETE_TEMPABSENT=(SELECT CONCAT('DELETE FROM ',DESTINATIONSCHEMA,'.TEMP_REPORTS_SCDB_FORMAT WHERE UID IN (SELECT UID FROM ',DESTINATIONSCHEMA,'.TEMP_ABSENT)'));
	PREPARE DELETE_TEMPABSENT_STMT FROM @DELETE_TEMPABSENT;
	EXECUTE DELETE_TEMPABSENT_STMT;

	SET @ABSMINID = (SELECT CONCAT('SELECT MIN(ID) INTO @ABSMIN_ID FROM ',DESTINATIONSCHEMA,'.TEMP_ABSENT'));
	PREPARE ABSMIN_ID_STMT FROM @ABSMINID;
	EXECUTE ABSMIN_ID_STMT;
	SET @ABSMAXID = (SELECT CONCAT('SELECT MAX(ID) INTO @ABSMAX_ID FROM ',DESTINATIONSCHEMA,'.TEMP_ABSENT'));
	PREPARE ABSMAX_ID_STMT FROM @ABSMAXID;
	EXECUTE ABSMAX_ID_STMT;
	SET ABS_MIN_ID = @ABSMIN_ID;
	SET ABS_MAX_ID = @ABSMAX_ID;
	WHILE(ABS_MIN_ID <= ABS_MAX_ID)DO         
		SET @SELECT_ABSENT_USERSTAMP_TIMESTAMP=(SELECT CONCAT('SELECT USERSTAMP, `TIMESTAMP` INTO @RUSERSTAMP, @RTIMESTAMP FROM ',DESTINATIONSCHEMA,'.TEMP_ABSENT WHERE ID=',ABS_MIN_ID));
    	PREPARE SELECT_ABSENT_USERSTAMP_TIMESTAMP_STMT FROM @SELECT_ABSENT_USERSTAMP_TIMESTAMP;
		EXECUTE SELECT_ABSENT_USERSTAMP_TIMESTAMP_STMT;
		SET ABS_USERSTAMP=@RUSERSTAMP;
		SET ABS_TIMESTAMP=@RTIMESTAMP;          
		-- FOR USERSTAMP AND TIMESTAMP
		IF (ABS_USERSTAMP IS NOT NULL OR ABS_TIMESTAMP IS NOT NULL) THEN 
			SET @INSERT_USERADMINREPORTDETAILS=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.TEMP_USER_ADMIN_REPORT_DETAILS(UARD_REASON,UARD_DATE,UARD_ATTENDANCE,UARD_AM_SESSION,UARD_PM_SESSION, URC_ID, ULD_ID, UARD_BANDWIDTH, UARD_USERSTAMP_ID, UARD_TIMESTAMP) VALUES 
			((SELECT DISTINCT UREPORT FROM ',DESTINATIONSCHEMA,'.TEMP_ABSENT WHERE ID=',ABS_MIN_ID,'),    
			(SELECT DISTINCT UDATE FROM ',DESTINATIONSCHEMA,'.TEMP_ABSENT WHERE ID=',ABS_MIN_ID,'),
			(SELECT DISTINCT AC_ID FROM ',DESTINATIONSCHEMA,'.ATTENDANCE_CONFIGURATION WHERE AC_DATA="0" AND CGN_ID=5),
			(SELECT DISTINCT AC_ID FROM ',DESTINATIONSCHEMA,'.ATTENDANCE_CONFIGURATION WHERE AC_DATA="ABSENT"),
			(SELECT DISTINCT AC_ID FROM ',DESTINATIONSCHEMA,'.ATTENDANCE_CONFIGURATION WHERE AC_DATA="ABSENT"),
			(SELECT DISTINCT RC.URC_ID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS ULD,',DESTINATIONSCHEMA,'.ROLE_CREATION RC,',DESTINATIONSCHEMA,'.USER_ACCESS UA,',DESTINATIONSCHEMA,'.TEMP_ABSENT RSF WHERE ULD.ULD_LOGINID= RSF.UNAME AND ULD.ULD_ID = UA.ULD_ID AND UA.RC_ID = RC.RC_ID AND RSF.ID=',ABS_MIN_ID,'),
			(SELECT DISTINCT ULD_ID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=(SELECT UNAME FROM ',DESTINATIONSCHEMA,'.TEMP_ABSENT WHERE ID=',ABS_MIN_ID,')),
			(0),(SELECT DISTINCT ULD_ID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=(SELECT USERSTAMP FROM ',DESTINATIONSCHEMA,'.TEMP_ABSENT WHERE ID=',ABS_MIN_ID,')),
			(SELECT DISTINCT TIMESTAMP FROM ',DESTINATIONSCHEMA,'.TEMP_ABSENT WHERE ID=',ABS_MIN_ID,'))'));      
			PREPARE INSERT_TEMP_USER_ADMIN_REPORT_DETAILS_STMT FROM @INSERT_USERADMINREPORTDETAILS;
			EXECUTE INSERT_TEMP_USER_ADMIN_REPORT_DETAILS_STMT;      
			-- QUERY FOR ALTER AUTO_INCREMENT 
			SET @UARDMAXID = (SELECT CONCAT('SELECT MAX(UARD_ID) INTO @UARD_MAX_ID FROM ',DESTINATIONSCHEMA,'.TEMP_USER_ADMIN_REPORT_DETAILS'));
			PREPARE UARD_MAX_ID_STMT FROM @UARDMAXID;
			EXECUTE UARD_MAX_ID_STMT;
			SET UARDMAX_ID=@UARD_MAX_ID;
			IF (UARDMAX_ID IS NOT NULL) THEN    
				SET @ALTER_USER_ADMIN_REPORT_DETAILS =(SELECT CONCAT('ALTER TABLE ',DESTINATIONSCHEMA,'.TEMP_USER_ADMIN_REPORT_DETAILS AUTO_INCREMENT=',UARDMAX_ID));
				PREPARE ALTER_USER_ADMIN_REPORT_DETAILS_STMT FROM @ALTER_USER_ADMIN_REPORT_DETAILS;
				EXECUTE ALTER_USER_ADMIN_REPORT_DETAILS_STMT;
			END IF;
		END IF;   
		IF (ABS_USERSTAMP IS NULL OR ABS_TIMESTAMP IS NULL) THEN
			SET @INSERT_USERADMINREPORTDETAILS=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.TEMP_USER_ADMIN_REPORT_DETAILS(UARD_REASON,UARD_DATE,UARD_ATTENDANCE,UARD_AM_SESSION,UARD_PM_SESSION, URC_ID, ULD_ID, UARD_BANDWIDTH, UARD_USERSTAMP_ID, UARD_TIMESTAMP) VALUES 
			((SELECT DISTINCT UREPORT FROM ',DESTINATIONSCHEMA,'.TEMP_ABSENT WHERE ID=',ABS_MIN_ID,'),    
			(SELECT DISTINCT UDATE FROM ',DESTINATIONSCHEMA,'.TEMP_ABSENT WHERE ID=',ABS_MIN_ID,'),
			(SELECT DISTINCT AC_ID FROM ',DESTINATIONSCHEMA,'.ATTENDANCE_CONFIGURATION WHERE AC_DATA="0" AND CGN_ID=5),
			(SELECT DISTINCT AC_ID FROM ',DESTINATIONSCHEMA,'.ATTENDANCE_CONFIGURATION WHERE AC_DATA="ABSENT"),
			(SELECT DISTINCT AC_ID FROM ',DESTINATIONSCHEMA,'.ATTENDANCE_CONFIGURATION WHERE AC_DATA="ABSENT"),
			(SELECT DISTINCT RC.URC_ID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS ULD,',DESTINATIONSCHEMA,'.ROLE_CREATION RC,',DESTINATIONSCHEMA,'.USER_ACCESS UA,',DESTINATIONSCHEMA,'.TEMP_ABSENT RSF WHERE ULD.ULD_LOGINID= RSF.UNAME AND ULD.ULD_ID = UA.ULD_ID AND UA.RC_ID = RC.RC_ID AND RSF.ID=',ABS_MIN_ID,'),
			(SELECT DISTINCT ULD_ID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=(SELECT UNAME FROM ',DESTINATIONSCHEMA,'.TEMP_ABSENT WHERE ID=',ABS_MIN_ID,')),
			(0),(SELECT DISTINCT ULD_ID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=(SELECT UNAME FROM ',DESTINATIONSCHEMA,'.TEMP_ABSENT WHERE ID=',ABS_MIN_ID,')),
			(SELECT DISTINCT UDATE FROM ',DESTINATIONSCHEMA,'.TEMP_ABSENT WHERE ID=',ABS_MIN_ID,'))'));      
			PREPARE INSERT_TEMP_USER_ADMIN_REPORT_DETAILS_STMT FROM @INSERT_USERADMINREPORTDETAILS;
			EXECUTE INSERT_TEMP_USER_ADMIN_REPORT_DETAILS_STMT; 
			-- QUERY FOR ALTER AUTO_INCREMENT 
			SET @UARDMAXID = (SELECT CONCAT('SELECT MAX(UARD_ID) INTO @UARD_MAX_ID FROM ',DESTINATIONSCHEMA,'.TEMP_USER_ADMIN_REPORT_DETAILS'));
			PREPARE UARD_MAX_ID_STMT FROM @UARDMAXID;
			EXECUTE UARD_MAX_ID_STMT;
			SET UARDMAX_ID=@UARD_MAX_ID;
			IF (UARDMAX_ID IS NOT NULL) THEN    
				SET @ALTER_USER_ADMIN_REPORT_DETAILS =(SELECT CONCAT('ALTER TABLE ',DESTINATIONSCHEMA,'.TEMP_USER_ADMIN_REPORT_DETAILS AUTO_INCREMENT=',UARDMAX_ID));
				PREPARE ALTER_USER_ADMIN_REPORT_DETAILS_STMT FROM @ALTER_USER_ADMIN_REPORT_DETAILS;
				EXECUTE ALTER_USER_ADMIN_REPORT_DETAILS_STMT;
			END IF;
		END IF;
		SET ABS_MIN_ID = ABS_MIN_ID+1;
	END WHILE;
	SET @DROP_TEMPABSENT=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_ABSENT'));
	PREPARE DROP_TEMPABSENT_STMT FROM @DROP_TEMPABSENT;
	EXECUTE DROP_TEMPABSENT_STMT;
	SET END_TIME = (SELECT CURTIME());
	SET DURATION=(SELECT TIMEDIFF(END_TIME,START_TIME));
	-- FOR CREATE DURATION OF TABLE CREATE-INSERT
	SET @DROP_TEMP_DURATION=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_DURATION'));
	PREPARE DROP_TEMP_DURATION_STMT FROM @DROP_TEMP_DURATION;
	EXECUTE DROP_TEMP_DURATION_STMT;
	SET @CREATE_TEMP_DURATION=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.TEMP_DURATION (
	ID INTEGER AUTO_INCREMENT NOT NULL PRIMARY KEY,
	DURATION TIME NOT NULL)'));
	PREPARE CREATE_TEMP_DURATION_STMT FROM @CREATE_TEMP_DURATION;
	EXECUTE CREATE_TEMP_DURATION_STMT;
	SET @INSERT_TEMP_DURATION=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.TEMP_DURATION(DURATION)VALUES(','"',DURATION,'"',')'));
	PREPARE INSERT_TEMP_DURATION_STMT FROM @INSERT_TEMP_DURATION;
	EXECUTE INSERT_TEMP_DURATION_STMT;
	COMMIT;
END;
/*
CALL SP_TS_MIG_REPORT_DETAILS_ABSENT_INSERT('SOURCE_RAJA','DEST_RAJA','dhandapani.sattanathan@ssomens.com');
*/