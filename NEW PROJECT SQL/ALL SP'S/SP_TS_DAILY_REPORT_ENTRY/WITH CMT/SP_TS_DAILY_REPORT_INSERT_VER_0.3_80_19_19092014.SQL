-- VERSION 0.3 STARTDATE:19/09/2014 ENDDATE:17909/2014 ISSUE NO:80 COMMENT NO:19 DESC:CHECKED OD AND ABSENT CONDITION FOR MULTIPLE DATE ENTRY. DONE BY :RAJA
-- VERSION 0.2 STARTDATE:17/09/2014 ENDDATE:17/09/2014 ISSUE NO:80 COMMENT NO:13 DESC:MODIFIED SP FOR MUTIPLE DATE ENTRY. DONE BY :RAJA
-- version:0.1 --sdate:06/09/2014 --edate:08/09/2014 --issue:80 -- comment:#3 --desc: SP FOR INSERTION OF DAILY REPORT  --done by:Bhavani.R
DROP PROCEDURE IF EXISTS SP_TS_DAILY_REPORT_INSERT;
CREATE PROCEDURE SP_TS_DAILY_REPORT_INSERT(
IN REPORT TEXT,
IN REASON TEXT,
IN SINGLE_DATE DATE, 
IN SECOND_DATE DATE,
IN URCID INT(11), 
IN LOGIN_ID TEXT, 
IN URE_PERMISSION VARCHAR(10),
IN URE_ATTENDANCE VARCHAR(10),
IN URE_PDID TEXT, 
IN URE_MORNING_SESSION VARCHAR(20), 
IN URE_AFTERNOON_SESSION VARCHAR(20),
IN BANDWIDTH DECIMAL(6,2), 
IN URE_ULD_ID TEXT,
OUT REPORT_SUCCESS INT(1))
BEGIN
	DECLARE ULDID INTEGER;
	DECLARE URE_ULDID INTEGER;
	DECLARE MIN_DATE DATE;
	DECLARE MAX_DATE DATE;
	DECLARE WEEKEND VARCHAR(10);
	DECLARE PUBLICHOLIDAY DATE;
	DECLARE ONDUTY DATE;
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK;
		SET REPORT_SUCCESS=0;
	END;
	SET AUTOCOMMIT=0;
	START TRANSACTION;
	SET REPORT_SUCCESS=0;
	-- FOR GET ULD_ID 
	CALL SP_TS_CHANGE_USERSTAMP_AS_ULDID(LOGIN_ID,@ULD_ID);
	SET ULDID=@ULD_ID;
	CALL SP_TS_CHANGE_USERSTAMP_AS_ULDID(URE_ULD_ID,@ULD_ID);
	SET URE_ULDID=@ULD_ID;

	IF REPORT='' THEN
		SET REPORT=NULL;
	END IF;
	IF REASON='' THEN
		SET REASON=NULL;
	END IF;
	IF URE_PERMISSION ='' THEN
		SET URE_PERMISSION=NULL;
	END IF;
	IF URE_PDID='' THEN
		SET URE_PDID= NULL;
	END IF;
	SET MIN_DATE=SINGLE_DATE;
	SET MAX_DATE=SECOND_DATE;

	--  FOR INSERT REPORT FOR SINGLE DATE 
	IF (SECOND_DATE IS NULL) THEN
		IF NOT EXISTS(SELECT UARD_DATE FROM USER_ADMIN_REPORT_DETAILS WHERE ULD_ID=ULDID AND UARD_DATE=SINGLE_DATE)THEN 
			INSERT INTO USER_ADMIN_REPORT_DETAILS (UARD_REPORT,UARD_REASON,UARD_DATE,URC_ID,ULD_ID,UARD_PERMISSION,UARD_ATTENDANCE,UARD_PDID,UARD_AM_SESSION,UARD_PM_SESSION,UARD_BANDWIDTH,UARD_USERSTAMP_ID)
			VALUES (REPORT,REASON,SINGLE_DATE,URCID,ULDID,(SELECT AC_ID FROM ATTENDANCE_CONFIGURATION WHERE CGN_ID=6 AND AC_DATA=URE_PERMISSION),(SELECT AC_ID FROM ATTENDANCE_CONFIGURATION WHERE CGN_ID=5 AND AC_DATA=URE_ATTENDANCE),URE_PDID,
			(SELECT AC_ID FROM ATTENDANCE_CONFIGURATION WHERE CGN_ID=4 AND AC_DATA=URE_MORNING_SESSION),(SELECT AC_ID FROM ATTENDANCE_CONFIGURATION WHERE CGN_ID=4 AND AC_DATA =URE_AFTERNOON_SESSION),BANDWIDTH,URE_ULDID);
			SET REPORT_SUCCESS=1; 
		END IF;
	END IF;
	--  FOR INSERT REPORT FOR MULTIPLE DATE
	IF (URE_ATTENDANCE='0' OR URE_ATTENDANCE='OD') THEN
		IF (SECOND_DATE IS NOT NULL) THEN
			WHILE(MIN_DATE<=MAX_DATE)DO
				SET WEEKEND=(SELECT DATE_FORMAT(MIN_DATE,'%W'));      
				SET PUBLICHOLIDAY=(SELECT PH_DATE FROM PUBLIC_HOLIDAY WHERE PH_DATE=MIN_DATE);
				SET ONDUTY=(SELECT OED_DATE FROM ONDUTY_ENTRY_DETAILS WHERE OED_DATE=MIN_DATE);
				IF(WEEKEND!='Sunday')THEN
					IF(PUBLICHOLIDAY IS NULL)THEN
						IF(ONDUTY IS NULL)THEN
							IF NOT EXISTS(SELECT UARD_DATE FROM USER_ADMIN_REPORT_DETAILS WHERE ULD_ID=ULDID AND UARD_DATE=MIN_DATE)THEN
								INSERT INTO USER_ADMIN_REPORT_DETAILS (UARD_REPORT,UARD_REASON,UARD_DATE,URC_ID,ULD_ID,UARD_PERMISSION,UARD_ATTENDANCE,UARD_PDID,UARD_AM_SESSION,UARD_PM_SESSION,UARD_BANDWIDTH,UARD_USERSTAMP_ID)
								VALUES (REPORT,REASON,MIN_DATE,URCID,ULDID,(SELECT AC_ID FROM ATTENDANCE_CONFIGURATION WHERE CGN_ID=6 AND AC_DATA=URE_PERMISSION),(SELECT AC_ID FROM ATTENDANCE_CONFIGURATION WHERE CGN_ID=5 AND AC_DATA=URE_ATTENDANCE),URE_PDID,
								(SELECT AC_ID FROM ATTENDANCE_CONFIGURATION WHERE CGN_ID=4 AND AC_DATA=URE_MORNING_SESSION),(SELECT AC_ID FROM ATTENDANCE_CONFIGURATION WHERE CGN_ID=4 AND AC_DATA =URE_AFTERNOON_SESSION),BANDWIDTH,URE_ULDID);
								SET REPORT_SUCCESS=1;
							END IF;
						END IF;
					END IF;
				END IF;      
				SET MIN_DATE=ADDDATE(MIN_DATE,1);      
			END WHILE;
		END IF;
	END IF;
	COMMIT;
END;
/* 
CALL SP_TS_DAILY_REPORT_INSERT('','ONDUTY','2014-09-16','2014-09-23','2','raja@gmail.com','','OD','','ONDUTY','ONDUTY',0.00,'raja@gmail.com',@SUCCESS_FLAG);
SELECT @SUCCESS_FLAG;
*/