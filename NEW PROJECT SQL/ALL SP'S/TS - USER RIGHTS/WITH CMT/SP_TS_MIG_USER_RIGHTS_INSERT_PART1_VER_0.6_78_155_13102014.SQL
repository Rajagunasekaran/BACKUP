-- VERSION 0.6 STARTDATE:13/10/2014 ENDDATE:13/10/2014 ISSUE NO:78 COMMENT NO:155 DESC:REMOVED TABLE CREATION QUERIES. DONE BY :RAJA
-- version:0.5  --sdate:13/10/2014 --edate:13/10/2014 -- issue:78 --COMMENT NO:149 --desc: ADDED TEMP LOGIN DETAILS IN USER LOGIN DETAILS AND USER ACCESS TABLE --doneby:DHIVYA
-- version:0.4  --sdate:09/10/2014 --edate:09/10/2014 -- issue:78 --COMMENT NO:131 --desc: splitted userrights migration sp for  argument too large error --doneby:BHAVANI.R
-- version:0.3  --sdate:02/09/2014 --edate:02/09/2014 -- issue:78 --COMMENT NO:47 --desc: CHANGED THE ALTER QUERY STATMENT FOR BASIC_MENU_PROFILE  --doneby:BHAVANI.R
-- version:0.2  --sdate:23/08/2014 --edate:25/08/2014 -- issue:78 --COMMENT NO:3 --desc: Migration of user rights dynamically for source and destination  --doneby:BHAVANI.R
-- version:0.1 --sdate:13/08/2014 --edate:13/08/2014 --issue:76 -- comment:#14 --desc: creation table sp for USER_RIGHTS  --done by:Bhavani.R
DROP PROCEDURE IF EXISTS SP_TS_MIG_USER_RIGHTS_INSERT_PART1;
CREATE PROCEDURE SP_TS_MIG_USER_RIGHTS_INSERT_PART1(IN SOURCESCHEMA VARCHAR(50),IN DESTINATIONSCHEMA VARCHAR(50),IN USERSTAMP VARCHAR(50))
BEGIN
	DECLARE START_TIME TIME;
	DECLARE END_TIME TIME;
	DECLARE DURATION TIME;
	DECLARE MIN_RID INTEGER;
	DECLARE MAX_RID INTEGER;
	DECLARE MIN_ULDID INTEGER;
	DECLARE MAX_ULDID INTEGER;
	DECLARE LOGINID INTEGER;
	DECLARE MIN_UMDID INTEGER;
	DECLARE MAX_UMDID INTEGER;
	DECLARE MAX_ID INTEGER;
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK;
		SET @DROP_TEMP_ROLE_CREATION=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_ROLE_CREATION'));
		PREPARE DROP_TEMP_ROLE_CREATION_STMT FROM @DROP_TEMP_ROLE_CREATION;
		EXECUTE DROP_TEMP_ROLE_CREATION_STMT;
		SET @DROP_TEMP_USER_LOGIN_DETAILS=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_USER_LOGIN_DETAILS'));
		PREPARE DROP_TEMP_USER_LOGIN_DETAILS_STMT FROM @DROP_TEMP_USER_LOGIN_DETAILS;
		EXECUTE DROP_TEMP_USER_LOGIN_DETAILS_STMT;
	END;
	SET AUTOCOMMIT = 0;
	START TRANSACTION;
	SET FOREIGN_KEY_CHECKS = 0;
	-- STATEMENT FOR CHANGING MIGUSERSTAMP AS ULD_ID 
	SET @LOGIN_ID=(SELECT CONCAT('SELECT ULD_ID INTO @ULDID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=','"',USERSTAMP,'"'));
	PREPARE LOGINID FROM @LOGIN_ID;
	EXECUTE LOGINID;
	SET START_TIME = (SELECT CURTIME());
  	
  	-- MENU_PROFILE
 	SET @SET_TRUNCATE=(SELECT CONCAT('TRUNCATE ',DESTINATIONSCHEMA,'.MENU_PROFILE'));
 	PREPARE SET_TRUNCATE_STMT FROM @SET_TRUNCATE;
 	EXECUTE SET_TRUNCATE_STMT;

	SET @INSERT_MENU_PROFILE=( SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.MENU_PROFILE (MP_MNAME, MP_MSUB, MP_MSUBMENU, MP_MFILENAME)SELECT MP_MNAME, MP_MSUB, MP_MSUBMENU, MP_MFILENAME FROM ',SOURCESCHEMA,'.USER_RIGHTS_SQL_FORMAT WHERE MP_MNAME IS NOT NULL AND MP_MFILENAME IS NOT NULL'));
	PREPARE INSERTMENUPROFILE FROM @INSERT_MENU_PROFILE;
	EXECUTE INSERTMENUPROFILE;

	  -- QUERY FOR ALTER AUTO_INCREMENT 
   SET @MAXID = (SELECT CONCAT('SELECT MAX(MP_ID) INTO @MENU_PROFILE_MAX_ID FROM ',DESTINATIONSCHEMA,'.MENU_PROFILE'));
   PREPARE MAX_ID_STMT FROM @MAXID;
   EXECUTE MAX_ID_STMT;
   SET MAX_ID=@MENU_PROFILE_MAX_ID;
   IF (MAX_ID IS NOT NULL) THEN    
     SET @ALTER_MENU_PROFILE =(SELECT CONCAT('ALTER TABLE ',DESTINATIONSCHEMA,'.MENU_PROFILE AUTO_INCREMENT=',MAX_ID));
     PREPARE ALTER_MENU_PROFILE_STMT FROM @ALTER_MENU_PROFILE;
     EXECUTE ALTER_MENU_PROFILE_STMT;
   END IF;
	
    SET END_TIME = (SELECT CURTIME());
    SET DURATION=(SELECT TIMEDIFF(END_TIME,START_TIME));
	SET @COUNT_MENU_PROFILE_SQL_FORMAT=(SELECT CONCAT('SELECT COUNT(*) INTO @COUNT_MENU_PROFILE_SQL_FORMAT FROM ',SOURCESCHEMA,'.USER_RIGHTS_SQL_FORMAT WHERE MP_MNAME IS NOT NULL AND MP_MFILENAME IS NOT NULL '));
	PREPARE COUNTMENUPROFILESQLFORMAT FROM @COUNT_MENU_PROFILE_SQL_FORMAT;
	EXECUTE COUNTMENUPROFILESQLFORMAT;
	 
	SET @COUNT_SPLITING_MENU_PROFILE=(SELECT CONCAT('SELECT COUNT(*) INTO @COUNT_SPLITING_MENU_PROFILE FROM ',DESTINATIONSCHEMA,'.MENU_PROFILE'));
	PREPARE COUNTSPLITINGMENUPROFILE FROM @COUNT_SPLITING_MENU_PROFILE;
	EXECUTE COUNTSPLITINGMENUPROFILE;
 
	SET @REJECTION_COUNT=(@COUNT_MENU_PROFILE_SQL_FORMAT-@COUNT_SPLITING_MENU_PROFILE);
    
	--  QUERY FOR UPDATE VALUES IN PRE_AUDIT_SUB_PROFILE TABLE
    UPDATE PRE_AUDIT_SUB_PROFILE SET PREASP_NO_OF_REC=@COUNT_MENU_PROFILE_SQL_FORMAT WHERE PREASP_DATA='MENU_PROFILE';

	-- QUERY FOR INSERTING VALUES IN POST AUDIT HISTORY TABLE
	INSERT INTO POST_AUDIT_HISTORY(POSTAP_ID,POSTAH_NO_OF_REC,PREASP_ID,PREAMP_ID,POSTAH_DURATION,POSTAH_NO_OF_REJ,ULD_ID)VALUES((SELECT POSTAP_ID FROM POST_AUDIT_PROFILE WHERE POSTAP_DATA='MENU_PROFILE'),@COUNT_SPLITING_MENU_PROFILE,
	(SELECT PREASP_ID FROM PRE_AUDIT_SUB_PROFILE WHERE PREASP_DATA='MENU_PROFILE'),
	(SELECT PREAMP_ID FROM PRE_AUDIT_MAIN_PROFILE WHERE PREAMP_DATA='USER RIGHTS'),DURATION,@REJECTION_COUNT,@ULDID);
 
 -- ROLE_CREATION
 	SET @SET_TRUNCATE=(SELECT CONCAT('TRUNCATE ',DESTINATIONSCHEMA,'.ROLE_CREATION'));
 	PREPARE SET_TRUNCATE_STMT FROM @SET_TRUNCATE;
 	EXECUTE SET_TRUNCATE_STMT;
	
	SET @DROP_TEMP_ROLE_CREATION=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_ROLE_CREATION'));
	PREPARE DROP_TEMP_ROLE_CREATION_STMT FROM @DROP_TEMP_ROLE_CREATION;
	EXECUTE DROP_TEMP_ROLE_CREATION_STMT;    

	SET @CREATE_TEMP_ROLE_CREATION=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.TEMP_ROLE_CREATION(
	ID INTEGER NOT NULL AUTO_INCREMENT PRIMARY KEY,
	ROLES VARCHAR(255) NULL,
	RUSERSTAMP VARCHAR(255) NULL,
	RTIMESTAMP TIMESTAMP NULL)'));
	PREPARE CREATE_TEMP_ROLE_CREATION_STMT FROM @CREATE_TEMP_ROLE_CREATION;
	EXECUTE CREATE_TEMP_ROLE_CREATION_STMT;

	SET @INSERT_TEMP_ROLE_CREATION=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.TEMP_ROLE_CREATION(ROLES,RUSERSTAMP,RTIMESTAMP)SELECT DISTINCT ROLES,USERSTAMP,TIMESTAMP FROM ',SOURCESCHEMA,'.USERRIGHTS_SCDB_FORMAT WHERE ROLES IS NOT NULL GROUP BY ROLES'));
	PREPARE INSERT_TEMP_ROLE_CREATION_STMT FROM @INSERT_TEMP_ROLE_CREATION;
	EXECUTE INSERT_TEMP_ROLE_CREATION_STMT;

	SET @UPDATE_TEMP_ROLE_CREATION=(SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_ROLE_CREATION SET ROLES=''SUPER ADMIN'' WHERE ROLES="SPCLAdmin"'));
	PREPARE UPDATE_TEMP_ROLE_CREATION_STMT FROM @UPDATE_TEMP_ROLE_CREATION;
	EXECUTE UPDATE_TEMP_ROLE_CREATION_STMT;

	SET @UPDATE_TEMP_ROLE_CREATION_UPPERCASE=(SELECT CONCAT('UPDATE ',DESTINATIONSCHEMA,'.TEMP_ROLE_CREATION SET ROLES= UCASE(ROLES)'));
	PREPARE UPDATE_TEMP_ROLE_CREATION_UPPERCASE_STMT FROM @UPDATE_TEMP_ROLE_CREATION_UPPERCASE;
	EXECUTE UPDATE_TEMP_ROLE_CREATION_UPPERCASE_STMT;

	SET @MINRIDSTMT=(SELECT CONCAT('SELECT MIN(ID) INTO @MINRID FROM ',DESTINATIONSCHEMA,'.TEMP_ROLE_CREATION'));
	PREPARE MINRID_STMT FROM @MINRIDSTMT;
	EXECUTE MINRID_STMT;
	SET MIN_RID=@MINRID ;
	SET @MAXRIDSTMT=(SELECT CONCAT('SELECT MAX(ID) INTO @MAXRID FROM ',DESTINATIONSCHEMA,'.TEMP_ROLE_CREATION'));
	PREPARE MAXRID_STMT FROM @MAXRIDSTMT;
	EXECUTE MAXRID_STMT;
	SET MAX_RID=@MAXRID;
	WHILE (MIN_RID<=MAX_RID) DO
	SET @INSERT_ROLE_CREATION=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.ROLE_CREATION(URC_ID,RC_NAME,RC_USERSTAMP,RC_TIMESTAMP)VALUES((SELECT URC_ID FROM ',DESTINATIONSCHEMA,'.USER_RIGHTS_CONFIGURATION WHERE URC_DATA=(SELECT ROLES FROM ',DESTINATIONSCHEMA,'.TEMP_ROLE_CREATION WHERE ID=',MIN_RID,')),(SELECT ROLES FROM ',DESTINATIONSCHEMA,'.TEMP_ROLE_CREATION WHERE ID=',MIN_RID,'),(SELECT RUSERSTAMP FROM ',DESTINATIONSCHEMA,'.TEMP_ROLE_CREATION WHERE ID=',MIN_RID,'),(SELECT RTIMESTAMP FROM ',DESTINATIONSCHEMA,'.TEMP_ROLE_CREATION WHERE ID=',MIN_RID,'))'));    
	PREPARE INSERT_ROLE_CREATION_STMT FROM @INSERT_ROLE_CREATION;
	EXECUTE INSERT_ROLE_CREATION_STMT;
	SET MIN_RID=MIN_RID+1;
	END WHILE;
	
	-- QUERY FOR ALTER AUTO_INCREMENT 
   SET @MAXID = (SELECT CONCAT('SELECT MAX(RC_ID) INTO @ROLE_CREATION_MAX_ID FROM ',DESTINATIONSCHEMA,'.ROLE_CREATION'));
   PREPARE MAX_ID_STMT FROM @MAXID;
   EXECUTE MAX_ID_STMT;
   SET MAX_ID=@ROLE_CREATION_MAX_ID;
   IF (MAX_ID IS NOT NULL) THEN    
     SET @ALTER_ROLE_CREATION =(SELECT CONCAT('ALTER TABLE ',DESTINATIONSCHEMA,'.ROLE_CREATION AUTO_INCREMENT=',MAX_ID));
     PREPARE ALTER_ROLE_CREATION_STMT FROM @ALTER_ROLE_CREATION;
     EXECUTE ALTER_ROLE_CREATION_STMT;
   END IF;
	
	SET END_TIME = (SELECT CURTIME());
	SET DURATION=(SELECT TIMEDIFF(END_TIME,START_TIME));

	SET @COUNTROLE_CREATION_SCDB_FORMAT = (SELECT CONCAT('SELECT COUNT(distinct(roles)) INTO @COUNT_ROLE_CREATION_SCDB_FORMAT FROM  ',SOURCESCHEMA,'.USERRIGHTS_SCDB_FORMAT WHERE roles IS NOT NULL'));
	PREPARE COUNTROLE_CREATION_SCDB_FORMAT_STMT FROM @COUNTROLE_CREATION_SCDB_FORMAT;
	EXECUTE COUNTROLE_CREATION_SCDB_FORMAT_STMT;
	SET @COUNTSPLITING_ROLE_CREATION = (SELECT CONCAT('SELECT COUNT(*) INTO @COUNT_SPLITING_ROLE_CREATION FROM ',DESTINATIONSCHEMA,'.ROLE_CREATION'));
	PREPARE COUNTSPLITING_ROLE_CREATION_STMT FROM @COUNTSPLITING_ROLE_CREATION;
	EXECUTE COUNTSPLITING_ROLE_CREATION_STMT;
	SET @REJECTION_COUNT=(@COUNT_ROLE_CREATION_SCDB_FORMAT-@COUNT_SPLITING_ROLE_CREATION);
	UPDATE PRE_AUDIT_SUB_PROFILE SET PREASP_NO_OF_REC = @COUNT_ROLE_CREATION_SCDB_FORMAT WHERE PREASP_DATA='ROLE_CREATION';
	INSERT INTO POST_AUDIT_HISTORY(POSTAP_ID,POSTAH_NO_OF_REC,PREASP_ID,PREAMP_ID,POSTAH_DURATION,POSTAH_NO_OF_REJ,ULD_ID)VALUES((SELECT POSTAP_ID FROM POST_AUDIT_PROFILE WHERE POSTAP_DATA='ROLE_CREATION'),@COUNT_SPLITING_ROLE_CREATION,
	(SELECT PREASP_ID FROM PRE_AUDIT_SUB_PROFILE WHERE PREASP_DATA='ROLE_CREATION'),
	(SELECT PREAMP_ID FROM PRE_AUDIT_MAIN_PROFILE WHERE PREAMP_DATA='USER RIGHTS'),DURATION,@REJECTION_COUNT,@ULDID);
  -- USER_LOGIN_DETAILS
  -- STATEMENT FOR DROPPING USER_LOGIN_DETAILS 
  	SET FOREIGN_KEY_CHECKS = 0;
	SET @SET_TRUNCATE=(SELECT CONCAT('TRUNCATE ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS'));
 	PREPARE SET_TRUNCATE_STMT FROM @SET_TRUNCATE;
 	EXECUTE SET_TRUNCATE_STMT;
  -- STATEMENT FOR DROPPING TEMP_USER_RIGHTS_SCDB_FORMAT 
	SET @DROP_TEMP_USER_RIGHTS_SCDB_FORMAT=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_USER_RIGHTS_SCDB_FORMAT'));
	PREPARE DROP_TEMP_USER_RIGHTS_SCDB_FORMAT_STMT FROM @DROP_TEMP_USER_RIGHTS_SCDB_FORMAT;
	EXECUTE DROP_TEMP_USER_RIGHTS_SCDB_FORMAT_STMT;
  -- STATEMENT FOR CREATING USER_LOGIN_DETAILS
	SET @CREATE_TEMP_USER_RIGHTS_SCDB_FORMAT=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.TEMP_USER_RIGHTS_SCDB_FORMAT AS SELECT * FROM USERRIGHTS_SCDB_FORMAT'));
	PREPARE CREATE_TEMP_USER_RIGHTS_SCDB_FORMAT_STMT FROM @CREATE_TEMP_USER_RIGHTS_SCDB_FORMAT;
	EXECUTE CREATE_TEMP_USER_RIGHTS_SCDB_FORMAT_STMT;
  -- STATEMENT FOR ALTER TEMP_USER_RIGHTS_SCDB_FORMAT
	SET @ALTER_TEMP_USER_RIGHTS_SCDB_FORMAT=(SELECT CONCAT('ALTER TABLE ',DESTINATIONSCHEMA,'.TEMP_USER_RIGHTS_SCDB_FORMAT MODIFY COLUMN Rid INTEGER'));
	PREPARE ALTER_TEMP_USER_RIGHTS_SCDB_FORMAT_STMT FROM @ALTER_TEMP_USER_RIGHTS_SCDB_FORMAT;
	EXECUTE ALTER_TEMP_USER_RIGHTS_SCDB_FORMAT_STMT;

	-- STATEMENT FOR DROPPING TEMP_USER_RIGHTS_SCDB_FORMAT 
	SET @DROP_TEMPORARY_USER_RIGHTS_SCDB_FORMAT=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMPORARY_USER_RIGHTS_SCDB_FORMAT'));
	PREPARE DROP_TEMPORARY_USER_RIGHTS_SCDB_FORMAT_STMT FROM @DROP_TEMPORARY_USER_RIGHTS_SCDB_FORMAT;
	EXECUTE DROP_TEMPORARY_USER_RIGHTS_SCDB_FORMAT_STMT;
  -- STATEMENT FOR CREATING USER_LOGIN_DETAILS
	SET @CREATE_TEMPORARY_USER_RIGHTS_SCDB_FORMAT=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.TEMPORARY_USER_RIGHTS_SCDB_FORMAT AS SELECT * FROM TEMP_EMP_USER_RIGHTS_SCDB_FORMAT'));
	PREPARE CREATE_TEMPORARY_USER_RIGHTS_SCDB_FORMAT_STMT FROM @CREATE_TEMPORARY_USER_RIGHTS_SCDB_FORMAT;
	EXECUTE CREATE_TEMPORARY_USER_RIGHTS_SCDB_FORMAT_STMT;
  -- STATEMENT FOR ALTER TEMP_USER_RIGHTS_SCDB_FORMAT
	SET @ALTER_TEMPORARY_USER_RIGHTS_SCDB_FORMAT=(SELECT CONCAT('ALTER TABLE ',DESTINATIONSCHEMA,'.TEMPORARY_USER_RIGHTS_SCDB_FORMAT MODIFY COLUMN Rid INTEGER'));
	PREPARE ALTER_TEMPORARY_USER_RIGHTS_SCDB_FORMAT_STMT FROM @ALTER_TEMPORARY_USER_RIGHTS_SCDB_FORMAT;
	EXECUTE ALTER_TEMPORARY_USER_RIGHTS_SCDB_FORMAT_STMT;

	SET @DROP_TEMP_USER_LOGIN_DETAILS=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_USER_LOGIN_DETAILS'));
	PREPARE DROP_TEMP_USER_LOGIN_DETAILS_STMT FROM @DROP_TEMP_USER_LOGIN_DETAILS;
	EXECUTE DROP_TEMP_USER_LOGIN_DETAILS_STMT;
  
	SET @CREATE_TEMP_USER_LOGIN_DETAILS=(SELECT CONCAT('CREATE TABLE ',DESTINATIONSCHEMA,'.TEMP_USER_LOGIN_DETAILS( ULD_ID INTEGER(2) NOT NULL AUTO_INCREMENT,	ULD_LOGINID	VARCHAR(40)	 NOT NULL,ULD_USERSTAMP VARCHAR(50) NOT NULL,ULD_TIMESTAMP TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,PRIMARY KEY(ULD_ID))'));
	PREPARE CREATE_TEMP_USER_LOGIN_DETAILS_STMT FROM @CREATE_TEMP_USER_LOGIN_DETAILS;
	EXECUTE CREATE_TEMP_USER_LOGIN_DETAILS_STMT;
     
	SET @INSERT_TEMP_USER_LOGIN_DETAILS=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.TEMP_USER_LOGIN_DETAILS(ULD_LOGINID,ULD_USERSTAMP,ULD_TIMESTAMP)(SELECT DISTINCT(UNAME),USERSTAMP,TIMESTAMP FROM ',DESTINATIONSCHEMA,'.TEMP_USER_RIGHTS_SCDB_FORMAT WHERE UNAME IS NOT NULL ORDER BY Rid ASC)'));
	PREPARE INSERT_TEMP_USER_LOGIN_DETAILS_STMT FROM @INSERT_TEMP_USER_LOGIN_DETAILS;
	EXECUTE INSERT_TEMP_USER_LOGIN_DETAILS_STMT;

	SET @INSERT_TEMPORARY_USER_LOGIN_DETAILS=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.TEMP_USER_LOGIN_DETAILS(ULD_LOGINID,ULD_USERSTAMP,ULD_TIMESTAMP)(SELECT DISTINCT(UNAME),USERSTAMP,TIMESTAMP FROM ',DESTINATIONSCHEMA,'.TEMPORARY_USER_RIGHTS_SCDB_FORMAT WHERE UNAME IS NOT NULL ORDER BY Rid ASC)'));
	PREPARE INSERT_TEMPORARY_USER_LOGIN_DETAILS_STMT FROM @INSERT_TEMPORARY_USER_LOGIN_DETAILS;
	EXECUTE INSERT_TEMPORARY_USER_LOGIN_DETAILS_STMT;

	SET @MINULDID=(SELECT CONCAT('SELECT MIN(ULD_ID) INTO @MIN_ULD_ID FROM ',DESTINATIONSCHEMA,'.TEMP_USER_LOGIN_DETAILS'));
	PREPARE MINULDID_STMT FROM @MINULDID;
	EXECUTE MINULDID_STMT;
	SET MIN_ULDID = @MIN_ULD_ID;

	SET @MAXULDID=(SELECT CONCAT('SELECT MAX(ULD_ID) INTO @MAX_ULD_ID FROM ',DESTINATIONSCHEMA,'.TEMP_USER_LOGIN_DETAILS'));
	PREPARE MAXULDID_STMT FROM @MAXULDID;
	EXECUTE MAXULDID_STMT;
	SET MAX_ULDID = @MAX_ULD_ID;

	WHILE(MIN_ULDID<=MAX_ULDID)DO

	SET @SELECT_LOGINID=(SELECT CONCAT('SELECT  COUNT(ULD_LOGINID) INTO @TEMP_LOGINID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=(SELECT ULD_LOGINID FROM ',DESTINATIONSCHEMA,'.TEMP_USER_LOGIN_DETAILS WHERE ULD_ID=',MIN_ULDID,')'));
	PREPARE SELECT_LOGINID_STMT FROM @SELECT_LOGINID;
	EXECUTE SELECT_LOGINID_STMT;
	SET LOGINID=@TEMP_LOGINID;

	IF LOGINID =0 THEN
		SET @INSERT_USER_LOGIN_DETAILS=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS(ULD_LOGINID,ULD_USERSTAMP,ULD_TIMESTAMP)(SELECT DISTINCT(ULD_LOGINID),ULD_USERSTAMP,ULD_TIMESTAMP FROM ',DESTINATIONSCHEMA,'.TEMP_USER_LOGIN_DETAILS WHERE ULD_ID=',MIN_ULDID,')'));
		PREPARE INSERT_USER_LOGIN_DETAILS_STMT FROM @INSERT_USER_LOGIN_DETAILS;
		EXECUTE INSERT_USER_LOGIN_DETAILS_STMT;
	END IF;
	SET MIN_ULDID=MIN_ULDID+1;
END WHILE;

	-- QUERY FOR ALTER AUTO_INCREMENT 
   SET @MAXID = (SELECT CONCAT('SELECT MAX(ULD_ID) INTO @USER_LOGIN_DETAILS_MAX_ID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS'));
   PREPARE MAX_ID_STMT FROM @MAXID;
   EXECUTE MAX_ID_STMT;
   SET MAX_ID=@USER_LOGIN_DETAILS_MAX_ID;
   IF (MAX_ID IS NOT NULL) THEN    
     SET @ALTER_USER_LOGIN_DETAILS =(SELECT CONCAT('ALTER TABLE ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS AUTO_INCREMENT=',MAX_ID));
     PREPARE ALTER_USER_LOGIN_DETAILS_STMT FROM @ALTER_USER_LOGIN_DETAILS;
     EXECUTE ALTER_USER_LOGIN_DETAILS_STMT;
   END IF;

	SET END_TIME = (SELECT CURTIME());
	SET DURATION=(SELECT TIMEDIFF(END_TIME,START_TIME));
	SET @COUNTUSER_LOGIN_DETAILS_SCDB_FORMAT = (SELECT CONCAT('SELECT COUNT(DISTINCT(UNAME))  INTO @COUNT1 FROM ',SOURCESCHEMA,'.USERRIGHTS_SCDB_FORMAT WHERE UNAME IS NOT NULL'));
	PREPARE COUNTUSER_LOGIN_DETAILS_SCDB_FORMAT_STMT FROM @COUNTUSER_LOGIN_DETAILS_SCDB_FORMAT;
	EXECUTE COUNTUSER_LOGIN_DETAILS_SCDB_FORMAT_STMT;
	SET @COUNTTEMPUSER_LOGIN_DETAILS_SCDB_FORMAT = (SELECT CONCAT('SELECT COUNT(DISTINCT(UNAME))  INTO @COUNT2 FROM ',SOURCESCHEMA,'.TEMP_EMP_USER_RIGHTS_SCDB_FORMAT WHERE UNAME IS NOT NULL'));
	PREPARE COUNTTEMPUSER_LOGIN_DETAILS_SCDB_FORMAT_STMT FROM @COUNTTEMPUSER_LOGIN_DETAILS_SCDB_FORMAT;
	EXECUTE COUNTTEMPUSER_LOGIN_DETAILS_SCDB_FORMAT_STMT;
	SET @COUNT_USER_LOGIN_DETAILS_SCDB_FORMAT=(@COUNT1+@COUNT2);
	SET @COUNTSPLITING_USER_LOGIN_DETAILS = (SELECT CONCAT('SELECT COUNT(*) INTO @COUNT_SPLITING_USER_LOGIN_DETAILS FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS'));
	PREPARE COUNTSPLITING_USER_LOGIN_DETAILS_STMT FROM @COUNTSPLITING_USER_LOGIN_DETAILS;
	EXECUTE COUNTSPLITING_USER_LOGIN_DETAILS_STMT;
	SET @REJECTION_COUNT=(@COUNT_USER_LOGIN_DETAILS_SCDB_FORMAT-@COUNT_SPLITING_USER_LOGIN_DETAILS);
	UPDATE PRE_AUDIT_SUB_PROFILE SET PREASP_NO_OF_REC = @COUNT_USER_LOGIN_DETAILS_SCDB_FORMAT WHERE PREASP_DATA='USER_LOGIN_DETAILS';
	INSERT INTO POST_AUDIT_HISTORY(POSTAP_ID,POSTAH_NO_OF_REC,PREASP_ID,PREAMP_ID,POSTAH_DURATION,POSTAH_NO_OF_REJ,ULD_ID)VALUES((SELECT POSTAP_ID FROM POST_AUDIT_PROFILE WHERE POSTAP_DATA='USER_LOGIN_DETAILS'),@COUNT_SPLITING_USER_LOGIN_DETAILS,
	(SELECT PREASP_ID FROM PRE_AUDIT_SUB_PROFILE WHERE PREASP_DATA='USER_LOGIN_DETAILS'),
	(SELECT PREAMP_ID FROM PRE_AUDIT_MAIN_PROFILE WHERE PREAMP_DATA='USER RIGHTS'),DURATION,@REJECTION_COUNT,@ULDID);
  SET @DROP_TEMP_ROLE_CREATION=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_ROLE_CREATION'));
	PREPARE DROP_TEMP_ROLE_CREATION_STMT FROM @DROP_TEMP_ROLE_CREATION;
	EXECUTE DROP_TEMP_ROLE_CREATION_STMT;
 	SET @DROP_TEMP_USER_LOGIN_DETAILS=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMP_USER_LOGIN_DETAILS'));
	PREPARE DROP_TEMP_USER_LOGIN_DETAILS_STMT FROM @DROP_TEMP_USER_LOGIN_DETAILS;
	EXECUTE DROP_TEMP_USER_LOGIN_DETAILS_STMT;
	SET @DROP_TEMP_USER_LOGIN_DETAILS=(SELECT CONCAT('DROP TABLE IF EXISTS ',DESTINATIONSCHEMA,'.TEMPORARY_USER_RIGHTS_SCDB_FORMAT'));
	PREPARE DROP_TEMP_USER_LOGIN_DETAILS_STMT FROM @DROP_TEMP_USER_LOGIN_DETAILS;
	EXECUTE DROP_TEMP_USER_LOGIN_DETAILS_STMT;
  SET FOREIGN_KEY_CHECKS = 1;
  COMMIT;
END;
/*
SP_TS_MIG_USER_RIGHTS_INSERT_PART1('RAJA_SOURCE','RAJA_DEST','dhandapani.sattanathan@ssomens.com');
*/