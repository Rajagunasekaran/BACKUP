-- VER 0.2 TRACKER NO:595 COMMENT #39 STARTDATE:20/01/2014 ENDDATE:21/01/2014 DESC:SP FOR CHARTS BIZ NET REVENUE FOR PER UNIT. DONE BY:MANIKANDAN.S
-- VER 0.3 ISSUE NO:595 COMMENT # STARTDATE:27/01/2014 ENDDATE:27/01/2014 DESC:CALLED SUB PROCEDURE FOR FORMATTING THE INPUT DATE. DONE BY:MANIKANDAN.S
-- VER 0.4 ISSUE NO:595 COMMENT # STARTDATE:29/01/2014 ENDDATE:29/01/2014 DESC:FIXED ISSUE IN ADDING UNIT RENTAL WITH BIZ EXPENSE, CONDITION FAILS DUE TO DATE FORMAT NOT MATCH. DONE BY:MANIKANDAN.S
-- VER 0.5 ISSUE NO:817 COMMENT #35 STARTDATE:09/05/2014 ENDDATE:09/05/2014 DESC:TEMP TABLE CHANGES FOR DYNAMIC PURPOSE. DONE BY:BHAVANI.R
-- VER 0.6 ISSUE NO:817 COMMENT #35 STARTDATE:20/05/2014 ENDDATE:20/05/2014 DESC: DROP THE TEMP TABLES. DONE BY:RAJA
DROP PROCEDURE IF EXISTS SP_CHARTS_BIZ_NET_REVENUE_PERUNIT;
CREATE PROCEDURE SP_CHARTS_BIZ_NET_REVENUE_PERUNIT(IN UNIT_NO INT, IN FROM_DATE VARCHAR(20), IN TO_DATE VARCHAR(20),IN USERSTAMP VARCHAR(50),OUT CHARTS_BIZ_NET_REVENUE_PERUNIT_TMPTBL TEXT)
BEGIN

DECLARE FINAL_FROM_DATE VARCHAR(20);
DECLARE FINAL_TO_DATE VARCHAR(20);

DECLARE V_UNIT_RENTAL INT DEFAULT 0;

DECLARE LI_T1_COUNT INT DEFAULT 0;
DECLARE LI_T2_COUNT INT DEFAULT 0;

DECLARE T1_MONTH_YEAR VARCHAR(20) DEFAULT 0;
DECLARE T2_MONTH_YEAR VARCHAR(20) DEFAULT 0;

DECLARE T1_VALUE DECIMAL(20,7) DEFAULT 0;
DECLARE T2_VALUE DECIMAL(20,7) DEFAULT 0;

DECLARE LI_MONTH_YEAR_T2  VARCHAR(20) DEFAULT 0;
DECLARE LI_VALUE_T2       DECIMAL(20,7) DEFAULT 0;

DECLARE I INT DEFAULT 1;
DECLARE J INT DEFAULT 1;

DECLARE T2_COUNT INT DEFAULT 0;
DECLARE T3_COUNT INT DEFAULT 0;
DECLARE FVALUE DECIMAL(20,7) DEFAULT 0;

DECLARE T1_SORT_DATE DATE;
DECLARE T2_SORT_DATE DATE;

DECLARE CHARTS_BIZ_EXPENSE_PERUNIT_TMPTBL TEXT;
DECLARE CHARTS_MAIN_BIZ_EXPENSE_PERUNIT TEXT;
DECLARE CHARTS_INTERMEDIATE_BIZ_EXPENSE TEXT;
DECLARE CHARTS_INTERMEDIATE_BIZ_EXPENSE_TMPTBL TEXT;
DECLARE CHARTS_GROSS_REVENUE_PERUNIT_TMPTBL TEXT;
DECLARE CHARTS_GROSS_REVENUE_PERUNIT_MAIN_TMPTBL TEXT;
DECLARE INTERMEDIATE_CHARTS_GROSS_REVENUE TEXT;
DECLARE INTERMEDIATE_CHARTS_GROSS_REVENUE_TMPTBL TEXT;
DECLARE CHARTS_TEMP_BIZ_NET_REVENUE_PERUNIT TEXT;
DECLARE USERSTAMP_ID INT;


DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
 ROLLBACK;
END;     
 --   TEMP TABLE NAME START
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
	SET USERSTAMP_ID=(SELECT @ULDID);
	SET CHARTS_MAIN_BIZ_EXPENSE_PERUNIT=(SELECT CONCAT('TEMP_CHARTS_BIZ_EXPENSE_PERUNIT',SYSDATE()));
	SET CHARTS_INTERMEDIATE_BIZ_EXPENSE=(SELECT CONCAT('TEMP_INTERMEDIATE_CHARTS_BIZ',SYSDATE()));
	SET CHARTS_GROSS_REVENUE_PERUNIT_MAIN_TMPTBL=(SELECT CONCAT('TEMP_CHARTS_GROSS_REVENUE_PERUNIT',SYSDATE()));
	SET INTERMEDIATE_CHARTS_GROSS_REVENUE=(SELECT CONCAT('TEMP_INTERMEDIATE_CHARTS_GROSS_REVENUE',SYSDATE()));
	SET CHARTS_TEMP_BIZ_NET_REVENUE_PERUNIT=(SELECT CONCAT('TEMP_CHARTS_BIZ_NET_REVENUE_PERUNIT',SYSDATE()));
--    NAME FOR CHARTS_BIZ_EXPENSE_PERUNIT_TMPTBL
	SET CHARTS_MAIN_BIZ_EXPENSE_PERUNIT=(SELECT REPLACE(CHARTS_MAIN_BIZ_EXPENSE_PERUNIT,' ',''));
	SET CHARTS_MAIN_BIZ_EXPENSE_PERUNIT=(SELECT REPLACE(CHARTS_MAIN_BIZ_EXPENSE_PERUNIT,'-',''));
	SET CHARTS_MAIN_BIZ_EXPENSE_PERUNIT=(SELECT REPLACE(CHARTS_MAIN_BIZ_EXPENSE_PERUNIT,':',''));
	SET CHARTS_BIZ_EXPENSE_PERUNIT_TMPTBL=(SELECT CONCAT(CHARTS_MAIN_BIZ_EXPENSE_PERUNIT,'_',USERSTAMP_ID)); 
-- NAME FOR CHARTS_INTERMEDIATE_BIZ_EXPENSE_TMPTBL
	SET CHARTS_INTERMEDIATE_BIZ_EXPENSE=(SELECT REPLACE(CHARTS_INTERMEDIATE_BIZ_EXPENSE,' ',''));
	SET CHARTS_INTERMEDIATE_BIZ_EXPENSE=(SELECT REPLACE(CHARTS_INTERMEDIATE_BIZ_EXPENSE,'-',''));
	SET CHARTS_INTERMEDIATE_BIZ_EXPENSE=(SELECT REPLACE(CHARTS_INTERMEDIATE_BIZ_EXPENSE,':',''));
	SET CHARTS_INTERMEDIATE_BIZ_EXPENSE_TMPTBL=(SELECT CONCAT(CHARTS_INTERMEDIATE_BIZ_EXPENSE,'_',USERSTAMP_ID));
--    NAME FOR CHARTS_GROSS_REVENUE_PERUNIT_TMPTBL
	SET CHARTS_GROSS_REVENUE_PERUNIT_MAIN_TMPTBL =(SELECT REPLACE(CHARTS_GROSS_REVENUE_PERUNIT_MAIN_TMPTBL,' ',''));
	SET CHARTS_GROSS_REVENUE_PERUNIT_MAIN_TMPTBL =(SELECT REPLACE(CHARTS_GROSS_REVENUE_PERUNIT_MAIN_TMPTBL,'-',''));
	SET CHARTS_GROSS_REVENUE_PERUNIT_MAIN_TMPTBL =(SELECT REPLACE(CHARTS_GROSS_REVENUE_PERUNIT_MAIN_TMPTBL,':',''));
	SET CHARTS_GROSS_REVENUE_PERUNIT_TMPTBL=(SELECT CONCAT(CHARTS_GROSS_REVENUE_PERUNIT_MAIN_TMPTBL,'_',USERSTAMP_ID)); 
-- NAME FOR INTERMEDIATE_CHARTS_GROSS_REVENUE_TMPTBL
	SET INTERMEDIATE_CHARTS_GROSS_REVENUE=(SELECT REPLACE(INTERMEDIATE_CHARTS_GROSS_REVENUE,' ',''));
	SET INTERMEDIATE_CHARTS_GROSS_REVENUE=(SELECT REPLACE(INTERMEDIATE_CHARTS_GROSS_REVENUE,'-',''));
	SET INTERMEDIATE_CHARTS_GROSS_REVENUE=(SELECT REPLACE(INTERMEDIATE_CHARTS_GROSS_REVENUE,':',''));
	SET INTERMEDIATE_CHARTS_GROSS_REVENUE_TMPTBL=(SELECT CONCAT(INTERMEDIATE_CHARTS_GROSS_REVENUE,'_',USERSTAMP_ID));
-- NAME FOR CHARTS_BIZ_NET_REVENUE_PERUNIT_TMPTBL
	SET CHARTS_TEMP_BIZ_NET_REVENUE_PERUNIT=(SELECT REPLACE(CHARTS_TEMP_BIZ_NET_REVENUE_PERUNIT,' ',''));
	SET CHARTS_TEMP_BIZ_NET_REVENUE_PERUNIT=(SELECT REPLACE(CHARTS_TEMP_BIZ_NET_REVENUE_PERUNIT,'-',''));
	SET CHARTS_TEMP_BIZ_NET_REVENUE_PERUNIT=(SELECT REPLACE(CHARTS_TEMP_BIZ_NET_REVENUE_PERUNIT,':',''));
	SET CHARTS_BIZ_NET_REVENUE_PERUNIT_TMPTBL=(SELECT CONCAT(CHARTS_TEMP_BIZ_NET_REVENUE_PERUNIT,'_',USERSTAMP_ID));
--   TEMP TABLE NAME END  
-- FORMAT THE INPUT DATE INTO PROPER DATE FORMAT.
		CALL SP_FORMAT_DATE(FROM_DATE,TO_DATE,@FD,@TD);
		SELECT @FD INTO FINAL_FROM_DATE;
		SELECT @TD INTO FINAL_TO_DATE;
  
  /* GETTING TOTAL BIZ EXPENSE*/
  -- CREATING MAIN TEMP TABLE FOR FINAL OUTPUT
		SET @CREATE_TEMP_CHARTS_BIZ_EXPENSE_PERUNIT=(SELECT CONCAT('CREATE TABLE ',CHARTS_BIZ_EXPENSE_PERUNIT_TMPTBL,'(ID INT NOT NULL AUTO_INCREMENT,MONTH_YEAR VARCHAR(20),TOTAL_BIZ_EXP DECIMAL(20,2),SORT_DATE DATE, PRIMARY KEY (ID))'));
		PREPARE CREATE_TEMP_CHARTS_BIZ_EXPENSE_PERUNIT_STMT FROM @CREATE_TEMP_CHARTS_BIZ_EXPENSE_PERUNIT;
		EXECUTE CREATE_TEMP_CHARTS_BIZ_EXPENSE_PERUNIT_STMT;
	
  
  -- CREATING INTERMEDIATE TEMP TABLE 

  
		SET @CREATE_TEMP_INTERMEDIATE_CHARTS_BIZ=(SELECT CONCAT('CREATE TABLE ',CHARTS_INTERMEDIATE_BIZ_EXPENSE_TMPTBL,'(MONTH_YEAR VARCHAR(20),CAR_PARK DECIMAL(7,2),DIGITAL_VOICE DECIMAL(7,2),ELECTRICITY DECIMAL(7,2),FACILITY_USE DECIMAL(7,2),MOVE_IN_OUT DECIMAL(7,2),STARHUB DECIMAL(7,2),UNIT_EXPENSE DECIMAL(7,2), DATE DATE)'));
		PREPARE CREATE_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT FROM @CREATE_TEMP_INTERMEDIATE_CHARTS_BIZ;
		EXECUTE CREATE_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT;
	
   		SET @INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ=(SELECT CONCAT('INSERT INTO ',CHARTS_INTERMEDIATE_BIZ_EXPENSE_TMPTBL,' (MONTH_YEAR, CAR_PARK, DATE)SELECT DATE_FORMAT(ECP.ECP_INVOICE_DATE,''%M-%Y''),ECP.ECP_AMOUNT, DATE_FORMAT(ECP.ECP_INVOICE_DATE,''%Y-%m-%1'') FROM EXPENSE_CARPARK ECP,EXPENSE_DETAIL_CARPARK EDCP,UNIT UN 
		WHERE  ECP.ECP_INVOICE_DATE BETWEEN ','"',FINAL_FROM_DATE,'"', ' AND ','"',FINAL_TO_DATE,'"',' AND ECP.EDCP_ID = EDCP.EDCP_ID AND EDCP.UNIT_ID = UN.UNIT_ID AND UN.UNIT_NO = ',UNIT_NO));
		PREPARE INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT FROM @INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ;
		EXECUTE INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT;
		
   		SET @INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ=(SELECT CONCAT('INSERT INTO ',CHARTS_INTERMEDIATE_BIZ_EXPENSE_TMPTBL,' (MONTH_YEAR, DIGITAL_VOICE, DATE)SELECT DATE_FORMAT(EDV.EDV_INVOICE_DATE,''%M-%Y''),EDV.EDV_AMOUNT, DATE_FORMAT(EDV.EDV_INVOICE_DATE,''%Y-%m-%1'') FROM EXPENSE_DIGITAL_VOICE EDV,EXPENSE_DETAIL_DIGITAL_VOICE EDDV,UNIT UN 
		WHERE  EDV.EDV_INVOICE_DATE BETWEEN ','"',FINAL_FROM_DATE,'"', ' AND ','"',FINAL_TO_DATE,'"',' AND EDV.EDDV_ID = EDDV.EDDV_ID AND EDDV.UNIT_ID = UN.UNIT_ID AND UN.UNIT_NO = ',UNIT_NO));
		PREPARE INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT FROM @INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ;
		EXECUTE INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT;

   		SET @INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ=(SELECT CONCAT('INSERT INTO ',CHARTS_INTERMEDIATE_BIZ_EXPENSE_TMPTBL,' (MONTH_YEAR, ELECTRICITY, DATE)SELECT DATE_FORMAT(EE.EE_INVOICE_DATE,''%M-%Y''),EE.EE_AMOUNT, DATE_FORMAT(EE.EE_INVOICE_DATE,''%Y-%m-%1'') FROM EXPENSE_ELECTRICITY EE,EXPENSE_DETAIL_ELECTRICITY EDE,UNIT UN 
		WHERE  EE.EE_INVOICE_DATE BETWEEN ','"',FINAL_FROM_DATE,'"', ' AND ','"',FINAL_TO_DATE,'"',' AND EE.EDE_ID = EDE.EDE_ID AND EDE.UNIT_ID = UN.UNIT_ID AND UN.UNIT_NO = ',UNIT_NO));
		PREPARE INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT FROM @INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ;
		EXECUTE INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT;

    	SET @INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ=(SELECT CONCAT('INSERT INTO ',CHARTS_INTERMEDIATE_BIZ_EXPENSE_TMPTBL,' (MONTH_YEAR, FACILITY_USE, DATE)SELECT DATE_FORMAT(EFU.EFU_INVOICE_DATE,''%M-%Y''),EFU.EFU_AMOUNT, DATE_FORMAT(EFU.EFU_INVOICE_DATE,''%Y-%m-%1'') FROM EXPENSE_FACILITY_USE EFU,UNIT UN 
		WHERE  EFU.EFU_INVOICE_DATE BETWEEN ','"',FINAL_FROM_DATE,'"', ' AND ','"',FINAL_TO_DATE,'"',' AND EFU.UNIT_ID = UN.UNIT_ID AND UN.UNIT_NO = ',UNIT_NO));
		PREPARE INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT FROM @INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ;
		EXECUTE INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT;

      	SET @INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ=(SELECT CONCAT('INSERT INTO ',CHARTS_INTERMEDIATE_BIZ_EXPENSE_TMPTBL,' (MONTH_YEAR, MOVE_IN_OUT, DATE)SELECT DATE_FORMAT(EMIO.EMIO_INVOICE_DATE,''%M-%Y''),EMIO.EMIO_AMOUNT, DATE_FORMAT(EMIO.EMIO_INVOICE_DATE,''%Y-%m-%1'') FROM EXPENSE_MOVING_IN_AND_OUT EMIO,UNIT UN 
		WHERE  EMIO.EMIO_INVOICE_DATE BETWEEN ','"',FINAL_FROM_DATE,'"', ' AND ','"',FINAL_TO_DATE,'"',' AND EMIO.UNIT_ID = UN.UNIT_ID AND UN.UNIT_NO = ',UNIT_NO));
		PREPARE INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT FROM @INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ;
		EXECUTE INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT;

      	SET @INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ=(SELECT CONCAT('INSERT INTO ',CHARTS_INTERMEDIATE_BIZ_EXPENSE_TMPTBL,' (MONTH_YEAR, STARHUB, DATE)SELECT DATE_FORMAT(ESH.ESH_INVOICE_DATE,''%M-%Y''),ESH.ESH_AMOUNT, DATE_FORMAT(ESH.ESH_INVOICE_DATE,''%Y-%m-%1'') FROM EXPENSE_STARHUB ESH,EXPENSE_DETAIL_STARHUB EDSH,UNIT UN 
		WHERE  ESH.ESH_INVOICE_DATE BETWEEN ','"',FINAL_FROM_DATE,'"', ' AND ','"',FINAL_TO_DATE,'"',' AND ESH.EDSH_ID = EDSH.EDSH_ID AND EDSH.UNIT_ID = UN.UNIT_ID AND UN.UNIT_NO = ',UNIT_NO));
		PREPARE INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT FROM @INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ;
		EXECUTE INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT;
		
      	SET @INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ=(SELECT CONCAT('INSERT INTO ',CHARTS_INTERMEDIATE_BIZ_EXPENSE_TMPTBL,' (MONTH_YEAR, UNIT_EXPENSE, DATE)SELECT DATE_FORMAT(EU.EU_INVOICE_DATE,''%M-%Y''),EU.EU_AMOUNT, DATE_FORMAT(EU.EU_INVOICE_DATE,''%Y-%m-%1'') FROM EXPENSE_UNIT EU,UNIT UN 
		WHERE  EU.EU_INVOICE_DATE BETWEEN ','"',FINAL_FROM_DATE,'"', ' AND ','"',FINAL_TO_DATE,'"',' AND EU.UNIT_ID = UN.UNIT_ID AND UN.UNIT_NO = ',UNIT_NO));
		PREPARE INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT FROM @INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ;
		EXECUTE INSERT_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT;



-- ASSIGNED BIZ EXPENSE VALUES IN VIEW FOR ADDING UNIT RENTAL.
		SET @CREATE_VIEW_BIZ_EXPENSE=(SELECT CONCAT('CREATE OR REPLACE VIEW VIEW_BIZ_EXPENSE AS SELECT MONTH_YEAR, SUM(COALESCE(CAR_PARK,'"0"'))+SUM(COALESCE(DIGITAL_VOICE,'"0"'))+ SUM(COALESCE(ELECTRICITY,'"0"'))+ SUM(COALESCE(FACILITY_USE,'"0"'))+ SUM(COALESCE(MOVE_IN_OUT,'"0"'))+ SUM(COALESCE(STARHUB,'"0"'))+ SUM(COALESCE(UNIT_EXPENSE,'"0"')) AS AMOUNT, DATE FROM ',CHARTS_INTERMEDIATE_BIZ_EXPENSE_TMPTBL,' GROUP BY MONTH_YEAR ORDER BY DATE'));
		PREPARE CREATE_VIEW_BIZ_EXPENSE_STMT FROM @CREATE_VIEW_BIZ_EXPENSE;
		EXECUTE CREATE_VIEW_BIZ_EXPENSE_STMT;
 
-- INSERTING INTO TEMP TABLE CONTAINING BIZ EXPENSE + UNIT RENTAL = TOTAL BIZ EXPENSE
  
		SET @INSERT_TEMP_CHARTS_BIZ_EXPENSE_PERUNIT=(SELECT CONCAT('INSERT INTO ',CHARTS_BIZ_EXPENSE_PERUNIT_TMPTBL,' (MONTH_YEAR , TOTAL_BIZ_EXP, SORT_DATE)SELECT T1.MONTH_YEAR, (T1.AMOUNT + IFNULL(UD.UD_PAYMENT,0)), T1.DATE FROM VIEW_BIZ_EXPENSE T1 LEFT JOIN UNIT_DETAILS UD INNER JOIN UNIT UN ON UD.UNIT_ID = UN.UNIT_ID AND UN.UNIT_NO = ',UNIT_NO,' ON DATE_FORMAT(T1.DATE,''%Y-%M'') BETWEEN DATE_FORMAT(UD.UD_START_DATE,''%Y-%M'') AND DATE_FORMAT(UD.UD_END_DATE,''%Y-%M'')'));
		PREPARE INSERT_TEMP_CHARTS_BIZ_EXPENSE_PERUNIT_STMT FROM @INSERT_TEMP_CHARTS_BIZ_EXPENSE_PERUNIT;
		EXECUTE INSERT_TEMP_CHARTS_BIZ_EXPENSE_PERUNIT_STMT;
		
 		SET @DROP_TEMP_INTERMEDIATE_CHARTS_BIZ=(SELECT CONCAT('DROP TABLE IF EXISTS ',CHARTS_INTERMEDIATE_BIZ_EXPENSE_TMPTBL));
		PREPARE DROP_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT FROM @DROP_TEMP_INTERMEDIATE_CHARTS_BIZ;
		EXECUTE DROP_TEMP_INTERMEDIATE_CHARTS_BIZ_STMT;
		

   
/* GETTING GROSS REVENUE*/
   
-- CREATING MAIN TEMP TABLE FOR FINAL OUTPUT
		SET @CREATE_TEMP_CHARTS_GROSS_REVENUE_PERUNIT=(SELECT CONCAT('CREATE TABLE ',CHARTS_GROSS_REVENUE_PERUNIT_TMPTBL,'(ID INT NOT NULL AUTO_INCREMENT, MONTH_YEAR VARCHAR(20),GROSS_REVENUE DECIMAL(20,2),SORT_DATE DATE, PRIMARY KEY (ID))'));
		PREPARE CREATE_TEMP_CHARTS_GROSS_REVENUE_PERUNIT_STMT FROM @CREATE_TEMP_CHARTS_GROSS_REVENUE_PERUNIT;
		EXECUTE CREATE_TEMP_CHARTS_GROSS_REVENUE_PERUNIT_STMT;
   
  
-- CREATING INTERMEDIATE TEMP TABLE 
		SET @CREATE_TEMP_INTERMEDIATE_CHARTS_GROSS_REVENUE=(SELECT CONCAT('CREATE TABLE ',INTERMEDIATE_CHARTS_GROSS_REVENUE_TMPTBL,'(MONTH_YEAR VARCHAR(20),GROSS_REVENUE DECIMAL(7,2),  DATE DATE)'));
		PREPARE CREATE_TEMP_INTERMEDIATE_CHARTS_GROSS_REVENUE_STMT FROM @CREATE_TEMP_INTERMEDIATE_CHARTS_GROSS_REVENUE;
		EXECUTE CREATE_TEMP_INTERMEDIATE_CHARTS_GROSS_REVENUE_STMT;

		SET @INSERT_TEMP_INTERMEDIATE_CHARTS_GROSS_REVENUE=(SELECT CONCAT('INSERT INTO ',INTERMEDIATE_CHARTS_GROSS_REVENUE_TMPTBL,' (MONTH_YEAR, GROSS_REVENUE, DATE)SELECT DATE_FORMAT(PD.PD_FOR_PERIOD,''%M-%Y''),PD.PD_AMOUNT, DATE_FORMAT(PD.PD_FOR_PERIOD,''%Y-%m-%1'') FROM PAYMENT_DETAILS PD,UNIT UN WHERE  PD.PD_FOR_PERIOD BETWEEN ','"',FINAL_FROM_DATE,'"', ' AND ','"',FINAL_TO_DATE,'"',' AND PD.UNIT_ID = UN.UNIT_ID AND UN.UNIT_NO = ',UNIT_NO));
		PREPARE INSERT_TEMP_INTERMEDIATE_CHARTS_GROSS_REVENUE_STMT FROM @INSERT_TEMP_INTERMEDIATE_CHARTS_GROSS_REVENUE;
		EXECUTE INSERT_TEMP_INTERMEDIATE_CHARTS_GROSS_REVENUE_STMT;
    
 	
-- INSERTING INTO TEMP TABLE FOR GROSS REVENUE GROUPING BY MONTH AND YEAR
		SET @INSERT_TEMP_CHARTS_GROSS_REVENUE_PERUNIT=(SELECT CONCAT('INSERT INTO ',CHARTS_GROSS_REVENUE_PERUNIT_TMPTBL,' (MONTH_YEAR , GROSS_REVENUE, SORT_DATE)(SELECT MONTH_YEAR,SUM(COALESCE(GROSS_REVENUE,'"0"')), DATE FROM ',INTERMEDIATE_CHARTS_GROSS_REVENUE_TMPTBL,' GROUP BY MONTH_YEAR ORDER BY DATE)'));
		PREPARE INSERT_TEMP_CHARTS_GROSS_REVENUE_PERUNIT_STMT FROM @INSERT_TEMP_CHARTS_GROSS_REVENUE_PERUNIT;
		EXECUTE INSERT_TEMP_CHARTS_GROSS_REVENUE_PERUNIT_STMT;
 
 		SET @DROP_TEMP_INTERMEDIATE_CHARTS_GROSS_REVENUE=(SELECT CONCAT('DROP TABLE IF EXISTS ',INTERMEDIATE_CHARTS_GROSS_REVENUE_TMPTBL));
		PREPARE DROP_TEMP_INTERMEDIATE_CHARTS_GROSS_REVENUE_STMT FROM @DROP_TEMP_INTERMEDIATE_CHARTS_GROSS_REVENUE;
		EXECUTE DROP_TEMP_INTERMEDIATE_CHARTS_GROSS_REVENUE_STMT;

   
/*CALCULATE BIZ NET REVENUE = GROSS - TOT BIZ EXP */
     
		SET @CREATE_TEMP_CHARTS_BIZ_NET_REVENUE_PERUNIT=(SELECT CONCAT('CREATE TABLE ',CHARTS_BIZ_NET_REVENUE_PERUNIT_TMPTBL,'(MONTH_YEAR VARCHAR(20),REVENUE DECIMAL(20,2))'));
		PREPARE CREATE_TEMP_CHARTS_BIZ_NET_REVENUE_PERUNIT_STMT FROM @CREATE_TEMP_CHARTS_BIZ_NET_REVENUE_PERUNIT;
		EXECUTE CREATE_TEMP_CHARTS_BIZ_NET_REVENUE_PERUNIT_STMT;
   
 
		SET @CREATE_VIEW_BIZ_NET_REVENUE =(SELECT CONCAT('CREATE OR REPLACE VIEW VIEW_BIZ_NET_REVENUE AS SELECT T1.MONTH_YEAR, (T1.GROSS_REVENUE-IFNULL(T2.TOTAL_BIZ_EXP,0)) AS REVENUE, T1.SORT_DATE FROM ',CHARTS_GROSS_REVENUE_PERUNIT_TMPTBL,' T1 LEFT JOIN ',CHARTS_BIZ_EXPENSE_PERUNIT_TMPTBL,' T2 ON T1.MONTH_YEAR = T2.MONTH_YEAR UNION SELECT T2.MONTH_YEAR, (IFNULL(T1.GROSS_REVENUE,0)-T2.TOTAL_BIZ_EXP) AS REVENUE, T2.SORT_DATE FROM ',CHARTS_GROSS_REVENUE_PERUNIT_TMPTBL,' T1 RIGHT JOIN ',CHARTS_BIZ_EXPENSE_PERUNIT_TMPTBL,' T2 ON T1.MONTH_YEAR = T2.MONTH_YEAR'));
		PREPARE CREATE_VIEW_BIZ_NET_REVENUE_STMT FROM @CREATE_VIEW_BIZ_NET_REVENUE;
		EXECUTE CREATE_VIEW_BIZ_NET_REVENUE_STMT;
  
-- INSERTING THE FINAL DATA ASCENDING ORDER OF DATE
        SET @INSERT_TEMP_CHARTS_BIZ_NET_REVENUE_PERUNIT=(SELECT CONCAT('INSERT INTO ',CHARTS_BIZ_NET_REVENUE_PERUNIT_TMPTBL,' (MONTH_YEAR, REVENUE)SELECT MONTH_YEAR, REVENUE FROM VIEW_BIZ_NET_REVENUE ORDER BY SORT_DATE'));
		PREPARE INSERT_TEMP_CHARTS_BIZ_NET_REVENUE_PERUNIT_STMT FROM @INSERT_TEMP_CHARTS_BIZ_NET_REVENUE_PERUNIT;
		EXECUTE INSERT_TEMP_CHARTS_BIZ_NET_REVENUE_PERUNIT_STMT;
  
   		  SET @DROP_TEMP_CHARTS_GROSS_REVENUE_PERUNIT=(SELECT CONCAT('DROP TABLE IF EXISTS ',CHARTS_GROSS_REVENUE_PERUNIT_TMPTBL));
		PREPARE DROP_TEMP_CHARTS_GROSS_REVENUE_PERUNIT_STMT FROM @DROP_TEMP_CHARTS_GROSS_REVENUE_PERUNIT;
		EXECUTE DROP_TEMP_CHARTS_GROSS_REVENUE_PERUNIT_STMT;

      	SET @DROP_TEMP_CHARTS_BIZ_EXPENSE_PERUNIT=(SELECT CONCAT('DROP TABLE IF EXISTS ',CHARTS_BIZ_EXPENSE_PERUNIT_TMPTBL));
		PREPARE DROP_TEMP_CHARTS_BIZ_EXPENSE_PERUNIT_STMT FROM @DROP_TEMP_CHARTS_BIZ_EXPENSE_PERUNIT;
		EXECUTE DROP_TEMP_CHARTS_BIZ_EXPENSE_PERUNIT_STMT;

    DROP VIEW IF EXISTS VIEW_BIZ_EXPENSE;

    DROP VIEW IF EXISTS VIEW_BIZ_NET_REVENUE;
	        
 COMMIT;
END;  
/* 
  CALL SP_CHARTS_BIZ_NET_REVENUE_PERUNIT(422, 'NOVEMBER-2013' , 'JANUARY-2014','EXPATSINTEGRATED@GMAIL.COM',@CHARTS_BIZ_NET_REVENUE_PERUNIT_TMPTBL);
select @CHARTS_BIZ_NET_REVENUE_PERUNIT_TMPTBL  
  SELECT*FROM TEMP_CHARTS_BIZ_NET_REVENUE_PERUNIT20140520120634_5
*/