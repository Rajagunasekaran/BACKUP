-- version:0.7 -- sdate:28/03/2014 -- edate:28/03/2014 -- issue:765 --desc:CHANGED SP DYNAMICALY --doneby:SAFI
-- version:0.6 -- sdate:17/03/2014 -- edate:17/03/2014 -- issue:765 --desc:droped temp table --doneby:RL
--version:0.5--sdate:22/02/2014 --edate:22/02/2014 --issue:750 -desc:changes source timestamp and userstamp as uld_id done by:dhivya
--version:0.4--sdate:22/02/2014 --edate:22/02/2014 --issue:750 -desc:added preaudit and post audit queries done by:dhivya
--VER 0.3 STARTDATE:01/02/2014 ENDATE:03/02/2014 ISSUE NO:718 DESC:CHANGED SP BY USING CURSOR CONCEPT DONE BY:DHIVYA
--INSERT QUERY FOR PERSONAL
DROP PROCEDURE IF EXISTS SP_MIG_EXPENSE_PERSONAL_INSERT;
CREATE PROCEDURE SP_MIG_EXPENSE_PERSONAL_INSERT(IN DESTINATIONSCHEMA  VARCHAR(50))
BEGIN
DECLARE DONE INT DEFAULT FALSE;
DECLARE PEID INTEGER;
DECLARE PERSONALEXPENSE TEXT;
DECLARE INVOICEDATE DATE;
DECLARE PERSONALAMOUNT DECIMAL(7,2);
DECLARE INVOICEITEM TEXT;
DECLARE INVOICEFROM VARCHAR(200);
DECLARE COMMENTS TEXT;
DECLARE PERSONAL_USERSTAMP VARCHAR(50);
DECLARE PERSONAL_TIMESTAMP TIMESTAMP;
DECLARE FILTER_CURSOR CURSOR FOR 
SELECT TPSF.PE_ID,TPSF.PE_PERSONAL_EXPENSE,TPSF.PE_PERSONAL_INVOICE_DATE,TPSF.PE_PERSONAL_AMOUNT, TPSF.USERSTAMP,TPSF.TIMESTAMP
FROM TEMP_PERSONAL_SCDB_FORMAT TPSF WHERE TPSF.PE_TYPE_OF_EXPENSE='PERSONAL';
DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE = TRUE;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK;
END;
START TRANSACTION;
OPEN FILTER_CURSOR;
read_loop: LOOP
FETCH FILTER_CURSOR INTO PEID,PERSONALEXPENSE,INVOICEDATE,PERSONALAMOUNT,PERSONAL_USERSTAMP,PERSONAL_TIMESTAMP;
IF DONE THEN
      LEAVE read_loop;
END IF;

SET @PERSONALID = PEID;
SET @PERSONALCATEGORY = PERSONALEXPENSE;
SET @PERSONALDATE = INVOICEDATE;
SET @PERSONAL_AMOUNT = PERSONALAMOUNT;
SET @PERSONALUSERSTAMP = PERSONAL_USERSTAMP;
SET @PERSONALTIMESTAMP = PERSONAL_TIMESTAMP;

SET @INSERT_EXPENSE_PERSONAL=(SELECT CONCAT('INSERT INTO ',DESTINATIONSCHEMA,'.EXPENSE_PERSONAL(ECN_ID,EP_INVOICE_DATE,EP_AMOUNT,EP_INVOICE_ITEMS,EP_INVOICE_FROM,EP_COMMENTS,ULD_ID,EP_TIMESTAMP)
VALUES((SELECT ECN_ID FROM ',DESTINATIONSCHEMA,'.EXPENSE_CONFIGURATION WHERE ECN_DATA=@PERSONALCATEGORY AND CGN_ID=24),
@PERSONALDATE,@PERSONAL_AMOUNT,
(SELECT DISTINCT PE_INVOICE_ITEMS FROM TEMP_PERSONAL_INVOICE_ITEM_FROM_SPLITTED_TABLE WHERE PE_ID=@PERSONALID),
(SELECT DISTINCT PE_INVOICE_FROM FROM TEMP_PERSONAL_INVOICE_ITEM_FROM_SPLITTED_TABLE WHERE PE_ID=@PERSONALID),
(SELECT DISTINCT PE_COMMENTS FROM TEMP_PERSONAL_INVOICE_ITEM_FROM_SPLITTED_TABLE WHERE PE_ID=@PERSONALID),
(SELECT ULD_ID FROM ',DESTINATIONSCHEMA,'.USER_LOGIN_DETAILS WHERE ULD_LOGINID=@PERSONALUSERSTAMP),
@PERSONALTIMESTAMP)'));
PREPARE INSERT_EXPENSE_PERSONAL_STMT FROM @INSERT_EXPENSE_PERSONAL;
EXECUTE INSERT_EXPENSE_PERSONAL_STMT;
END LOOP;
CLOSE FILTER_CURSOR;
COMMIT;
END;
