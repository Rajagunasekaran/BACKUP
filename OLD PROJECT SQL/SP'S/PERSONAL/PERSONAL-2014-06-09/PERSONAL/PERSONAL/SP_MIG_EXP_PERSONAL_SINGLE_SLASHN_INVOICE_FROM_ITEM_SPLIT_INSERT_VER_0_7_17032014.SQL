
-- version:0.7 -- sdate:28/03/2014 -- edate:28/03/2014 -- issue:765 --desc:CHANGED SP DYNAMICALY --doneby:SAFI
-- version:0.6 -- sdate:17/03/2014 -- edate:17/03/2014 -- issue:765 --desc:droped temp table --doneby:RL
--version:0.5--sdate:22/02/2014 --edate:22/02/2014 --issue:750 -desc:changes source timestamp and userstamp as uld_id done by:dhivya
--version:0.4--sdate:22/02/2014 --edate:22/02/2014 --issue:750 -desc:added preaudit and post audit queries done by:dhivya
--VER 0.3 STARTDATE:01/02/2014 ENDATE:03/02/2014 ISSUE NO:718 DESC:CHANGED SP BY USING CURSOR CONCEPT DONE BY:DHIVYA
DROP PROCEDURE IF EXISTS SP_MIG_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM_SPLIT_INSERT;
CREATE PROCEDURE SP_MIG_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM_SPLIT_INSERT()
BEGIN
DECLARE DONE INT DEFAULT FALSE;
DECLARE PEID INTEGER;
DECLARE PERSONALCOMMENTS TEXT;
DECLARE ITEMLOCATION INTEGER;
DECLARE FROMLOCATION INTEGER;
DECLARE INVOICEITEM TEXT;
DECLARE INVOICEFROM TEXT;
DECLARE INVITEM TEXT;
DECLARE INVFROM TEXT;
DECLARE FILTER_CURSOR CURSOR FOR 
SELECT PE_ID,PE_PERSONAL_COMMENTS,PE_PERSONAL_INVOICE_ITEMS,PE_PERSONAL_INVOICE_FROM FROM VW_MIG_TEMP_EXP_PERSONAL_DOUBLE_SLASHN_REMAINING_COMMENTS;
DECLARE CONTINUE HANDLER FOR NOT FOUND SET DONE = TRUE;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK;
END;
START TRANSACTION;
DROP TABLE IF EXISTS TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM;
CREATE TABLE TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM(ID INT NOT NULL AUTO_INCREMENT PRIMARY KEY,PE_ID INT NOT NULL ,PE_PERSONAL_COMMENTS TEXT,PE_INVOICE_ITEM TEXT,PE_INVOICE_FROM TEXT);
OPEN FILTER_CURSOR;
read_loop: LOOP
FETCH FILTER_CURSOR INTO PEID,PERSONALCOMMENTS,INVOICEITEM,INVOICEFROM;
IF DONE THEN
      LEAVE read_loop;
END IF;
SET ITEMLOCATION=(SELECT LOCATE('\n',PERSONALCOMMENTS));
SET FROMLOCATION=(SELECT LOCATE('\n\n',PERSONALCOMMENTS,ITEMLOCATION+1));
SET INVITEM=(SELECT SUBSTRING(PERSONALCOMMENTS,ITEMLOCATION+1,FROMLOCATION-(ITEMLOCATION+1)));
SET INVFROM=(SELECT SUBSTRING(PERSONALCOMMENTS,FROMLOCATION+1));
IF(ITEMLOCATION!=0) AND (FROMLOCATION!=0) THEN
		INSERT INTO TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM(PE_ID,PE_PERSONAL_COMMENTS,PE_INVOICE_ITEM,PE_INVOICE_FROM)VALUES(PEID,PERSONALCOMMENTS,INVITEM,INVFROM);
END IF;
END LOOP;
CLOSE FILTER_CURSOR;
IF EXISTS(SELECT PE_ID FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=1641)THEN
DELETE FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=1641;
END IF;
IF EXISTS(SELECT PE_ID FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=1824)THEN
DELETE FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=1824;
END IF;
IF EXISTS(SELECT PE_ID FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=2330)THEN
DELETE FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=2330;
END IF;
IF EXISTS(SELECT PE_ID FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=2483)THEN
DELETE FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=2483;
END IF;
IF EXISTS(SELECT PE_ID FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=2565)THEN
DELETE FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=2565;
END IF;
IF EXISTS(SELECT PE_ID FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=2795)THEN
DELETE FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=2795;
END IF;
IF EXISTS(SELECT PE_ID FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3145)THEN
DELETE FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3145;
END IF;
IF EXISTS(SELECT PE_ID FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3497)THEN
DELETE FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3497;
END IF;
IF EXISTS(SELECT PE_ID FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3584)THEN
DELETE FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3584;
END IF;
IF EXISTS(SELECT PE_ID FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3635)THEN
DELETE FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3635;
END IF;
IF EXISTS(SELECT PE_ID FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3639)THEN
DELETE FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3639;
END IF;
IF EXISTS(SELECT PE_ID FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3706)THEN
DELETE FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3706;
END IF;
IF EXISTS(SELECT PE_ID FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3739)THEN
DELETE FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3739;
END IF;
IF EXISTS(SELECT PE_ID FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3753)THEN
DELETE FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3753;
END IF;
IF EXISTS(SELECT PE_ID FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3786)THEN
DELETE FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3786;
END IF;
IF EXISTS(SELECT PE_ID FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3789)THEN
DELETE FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3789;
END IF;
IF EXISTS(SELECT PE_ID FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3790)THEN
DELETE FROM TEMP_EXP_PERSONAL_SINGLE_SLASHN_INVOICE_FROM_ITEM WHERE PE_ID=3790;
END IF;
COMMIT;
END;