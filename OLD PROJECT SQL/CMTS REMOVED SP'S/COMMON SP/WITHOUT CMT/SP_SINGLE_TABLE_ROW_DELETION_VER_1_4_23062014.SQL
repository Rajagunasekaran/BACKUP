DROP PROCEDURE IF EXISTS SP_SINGLE_TABLE_ROW_DELETION;
CREATE PROCEDURE SP_SINGLE_TABLE_ROW_DELETION(IN TABLE_ID INT, IN ROW_ID INT,IN V_USERSTAMP VARCHAR(50), OUT DELETION_FLAG SMALLINT(1))
BEGIN
	DECLARE V_TABLE_NAME        VARCHAR(64);
	DECLARE V_TEMP_TABLE_NAME   TEXT;
	DECLARE i                   INT DEFAULT 1;
	DECLARE V_COLUMN_VALUE      TEXT;
	DECLARE FINAL_DATA          TEXT DEFAULT '';
	DECLARE USERSTAMP_ID INTEGER(2);
	DECLARE CUSTOMERID INTEGER;
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
	  ROLLBACK;
  IF (V_TEMP_TABLE_NAME IS NOT NULL)THEN
		SET @DROPQUERY = (SELECT CONCAT('DROP TABLE IF EXISTS ',V_TEMP_TABLE_NAME,''));
		PREPARE DROPQUERYSTMT FROM @DROPQUERY;
		EXECUTE DROPQUERYSTMT;
	END IF;
	END;
  START TRANSACTION;
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(V_USERSTAMP,@ULDID);
	SET USERSTAMP_ID = (SELECT @ULDID);
	SELECT TRIM(TTIP_DATA) INTO V_TABLE_NAME FROM TICKLER_TABID_PROFILE WHERE TTIP_ID = TABLE_ID;
	SET @SQL = CONCAT('SELECT DISTINCT COLUMN_NAME INTO @V_TABLE_PRIMAY_COLUMN_ID FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = ''',V_TABLE_NAME,''' AND COLUMN_KEY = ','''PRI''' );
	PREPARE S1 FROM @SQL;
	EXECUTE S1;
	DEALLOCATE PREPARE S1;
	SET @SQL1 = CONCAT('SELECT COUNT(*) INTO @ROW_COUNT FROM ',V_TABLE_NAME,' WHERE ',@V_TABLE_PRIMAY_COLUMN_ID,' = ',ROW_ID);
    PREPARE s1 FROM @SQL1;
    EXECUTE s1;
    DEALLOCATE PREPARE s1;
	IF(@ROW_COUNT > 0) THEN
		SET V_TEMP_TABLE_NAME = CONCAT('TEMP_',V_TABLE_NAME,'_COLUMN_NAMES');
		SET @SQL = CONCAT('DROP TABLE IF EXISTS ',V_TEMP_TABLE_NAME);
		PREPARE S1 FROM @SQL;
		EXECUTE S1;
		DEALLOCATE PREPARE S1;
		SET @SQL = CONCAT('CREATE TABLE ',V_TEMP_TABLE_NAME,' (ID INT NOT NULL AUTO_INCREMENT, COLUMN_NAME VARCHAR(30), PRIMARY KEY (ID))');
		PREPARE S1 FROM @SQL;
		EXECUTE S1;
		DEALLOCATE PREPARE S1;
		SET @SQL = CONCAT('INSERT INTO ',V_TEMP_TABLE_NAME,'(COLUMN_NAME) SELECT DISTINCT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = ''',V_TABLE_NAME,"'" );
		PREPARE S1 FROM @SQL;
		EXECUTE S1;
		DEALLOCATE PREPARE S1;
		SET @SQL = CONCAT('SELECT COUNT(*) INTO @V_COLUMN_COUNT FROM ',V_TEMP_TABLE_NAME);
		PREPARE S1 FROM @SQL;
		EXECUTE S1;
		DEALLOCATE PREPARE S1;
		WHILE (@V_COLUMN_COUNT >= i) DO
		   SET @SQL = CONCAT('SELECT COLUMN_NAME INTO @V_COLUMN_NAME FROM ',V_TEMP_TABLE_NAME,' WHERE ID = ',i);
		   PREPARE S1 FROM @SQL;
		   EXECUTE S1;
		   DEALLOCATE PREPARE S1;
			SET @SQL1 = CONCAT('SELECT ',@V_COLUMN_NAME,' INTO @V_VALUE FROM ',V_TABLE_NAME,' WHERE ',@V_TABLE_PRIMAY_COLUMN_ID,' = ',ROW_ID);
			PREPARE s1 FROM @SQL1;
			EXECUTE s1;
			DEALLOCATE PREPARE s1;
			IF @V_VALUE IS null THEN
			  SET V_COLUMN_VALUE = 'null';
			ELSE
			  SET V_COLUMN_VALUE = @V_VALUE;
			END IF;
			SET FINAL_DATA = CONCAT(FINAL_DATA, @V_COLUMN_NAME, '=',V_COLUMN_VALUE,',');
			IF @V_COLUMN_NAME='CUSTOMER_ID' AND V_COLUMN_VALUE IS NOT NULL THEN
			SET CUSTOMERID=V_COLUMN_VALUE;
			END IF;
			SET i = i + 1;
		END WHILE;
		SET FINAL_DATA = SUBSTRING(FINAL_DATA,1,CHAR_LENGTH(FINAL_DATA)-1);
		IF FINAL_DATA IS NOT NULL THEN
			IF CUSTOMERID IS NOT NULL THEN
			SET @SQL2 = CONCAT('DELETE FROM ',V_TABLE_NAME,' WHERE ',@V_TABLE_PRIMAY_COLUMN_ID,' = ',ROW_ID);
			PREPARE s2 FROM @SQL2;
			EXECUTE s2;
			DEALLOCATE PREPARE s2;
			INSERT INTO TICKLER_HISTORY (TP_ID, TTIP_ID,CUSTOMER_ID,TH_OLD_VALUE, ULD_ID)VALUES (2, TABLE_ID,CUSTOMERID, FINAL_DATA, USERSTAMP_ID);
			SET DELETION_FLAG = 1;
			ELSE
			SET @SQL2 = CONCAT('DELETE FROM ',V_TABLE_NAME,' WHERE ',@V_TABLE_PRIMAY_COLUMN_ID,' = ',ROW_ID);
			PREPARE s2 FROM @SQL2;
			EXECUTE s2;
			DEALLOCATE PREPARE s2;
			INSERT INTO TICKLER_HISTORY (TP_ID, TTIP_ID, TH_OLD_VALUE, ULD_ID)VALUES (2, TABLE_ID, FINAL_DATA, USERSTAMP_ID);
			SET DELETION_FLAG = 1;
			END IF;
		ELSE
			SET DELETION_FLAG = 0;
		END IF;		
	ELSE
		SET DELETION_FLAG = 0;
	END IF;
	IF (V_TEMP_TABLE_NAME IS NOT NULL)THEN
		SET @DROPQUERY = (SELECT CONCAT('DROP TABLE IF EXISTS ',V_TEMP_TABLE_NAME,''));
		PREPARE DROPQUERYSTMT FROM @DROPQUERY;
		EXECUTE DROPQUERYSTMT;
	END IF;
COMMIT;
END;