-- VERSION 0.4 TARTDATE:23/09/2014 ENDDATE:23/09/2014 ISSUE NO:836 COMMENT NO:61 DESC:IMPLIMENTED ERROR MESSAGE GET FROM DB. DONE BY :RAJA
-- VER 0.3 STARTDATE:04/07/2014 ENDDATE:04/07/2014 ISSUE NO:303 COMMENT NO:416 DESC:CHANGING HADRCODED CONFIGURATION DATA INTO ID DONEBY:BHAVANI.R
-- VER 0.2 STARTDATE:09/06/2014 ENDDATE:09/06/2014 ISSUE NO:566COMMENT NO:12 DESC:ADDED ROLLBACK AND COMMIT DONE BY:SASIKALA
-- VER 0.1 STARTDATE:03/06/2014 ENDDATE:04/06/2014 ISSUE NO:817 COMMENT NO:132 DESC:SPLITTED INTO THREE PARTS DONE BY:DHIVYA.A


DROP PROCEDURE IF EXISTS SP_ACCESS_SEARCH_BY_UNIT_ERROR_MSG;
CREATE PROCEDURE SP_ACCESS_SEARCH_BY_UNIT_ERROR_MSG(IN CARD_NO INTEGER,IN TEMP_ACCESS TEXT,IN ACCESS_CARD_COUNT INTEGER,IN TEMP_CUSTOMER_UNIT TEXT,IN CARD_ID INTEGER,IN TEMP_CUSTOMER_UNIT_LOST_CARD TEXT,OUT SEARCH_SUCCESSMSG TEXT)
BEGIN
DECLARE CUSTOMER_VALUE INTEGER;
DECLARE MIN_ID INTEGER;
DECLARE MAX_ID INTEGER;
DECLARE CUSTOMER_NAME TEXT;
DECLARE LOSTCARD_CUSTOMER INTEGER;
DECLARE MINID_LOSTCARD INTEGER;
DECLARE MAXID_LOSTCARD INTEGER;
DECLARE CUSTOMER_NAME_LOSTCARD TEXT;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
ROLLBACK;
END;
SET CUSTOMER_NAME='';
SET CUSTOMER_NAME_LOSTCARD='';
IF EXISTS (SELECT UASD_ACCESS_CARD FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NO AND UASD_ACCESS_ACTIVE IS NOT NULL) THEN
SET @CUSTOMER_COUNT=(SELECT CONCAT('SELECT COUNT(*) INTO @CUSTOMERVALUE FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE ACN_ID IS NULL AND CACD_VALID_TILL IS NULL AND UASD_ID=(SELECT UASDID FROM ',TEMP_ACCESS,' WHERE ID=',ACCESS_CARD_COUNT,')'));
 PREPARE CUSTOMER_COUNT_STMT FROM @CUSTOMER_COUNT;
 EXECUTE CUSTOMER_COUNT_STMT;
  SET CUSTOMER_VALUE= @CUSTOMERVALUE;
  IF CUSTOMER_VALUE>1 THEN
			SET SEARCH_SUCCESSMSG='';
			SET @INSERT_TEMP_CUSTOMER_UNIT=(SELECT CONCAT('INSERT INTO ',TEMP_CUSTOMER_UNIT,'(CUSTOMERID) SELECT CUSTOMER_ID FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE ACN_ID IS NULL AND CACD_VALID_TILL IS NULL AND UASD_ID=(SELECT UASDID FROM ',TEMP_ACCESS,' WHERE ID=',ACCESS_CARD_COUNT,')'));
			PREPARE INSERT_TEMP_CUSTOMER_UNIT_STMT FROM @INSERT_TEMP_CUSTOMER_UNIT;
			EXECUTE INSERT_TEMP_CUSTOMER_UNIT_STMT;
			SET @MINID_VALUE=(SELECT CONCAT('SELECT MIN(ID)INTO @MINID FROM ',TEMP_CUSTOMER_UNIT));
			PREPARE MINID_VALUE_STMT FROM @MINID_VALUE;
			EXECUTE MINID_VALUE_STMT;
			SET MIN_ID=@MINID;
			SET @MAXID_VALUE=(SELECT CONCAT('SELECT MAX(ID)INTO @MAXID FROM ',TEMP_CUSTOMER_UNIT));
			PREPARE MAXID_VALUE_STMT FROM @MAXID_VALUE;
			EXECUTE MAXID_VALUE_STMT;
			SET MAX_ID=@MAXID;
			WHILE (MAX_ID>=MIN_ID) DO 
				SET @TEMP_CUSTOMER_NAME=(SELECT CONCAT('SELECT CONCAT (CUSTOMER_FIRST_NAME,'' '',CUSTOMER_LAST_NAME)AS CUSTOMERNAME INTO @TEMP_CUSTOMERNAME FROM CUSTOMER WHERE CUSTOMER_ID=(SELECT CUSTOMERID FROM ',TEMP_CUSTOMER_UNIT,' WHERE ID=',MIN_ID,')'));
				PREPARE TEMP_CUSTOMER_NAME_STMT FROM @TEMP_CUSTOMER_NAME;
				EXECUTE TEMP_CUSTOMER_NAME_STMT;
				IF(MIN_ID=1) THEN
					SET CUSTOMER_NAME=(SELECT CONCAT('',CUSTOMER_NAME,'',@TEMP_CUSTOMERNAME));
				ELSEIF (MIN_ID!=1)THEN
					SET CUSTOMER_NAME=(SELECT CONCAT('',CUSTOMER_NAME,',',@TEMP_CUSTOMERNAME));
				END IF;
				SET MIN_ID=MIN_ID+1;
      END WHILE;
        SET SEARCH_SUCCESSMSG=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=573);
        SET SEARCH_SUCCESSMSG=(SELECT REPLACE(SEARCH_SUCCESSMSG,'[CARD_NO]',CARD_NO));
        SET SEARCH_SUCCESSMSG=(SELECT REPLACE(SEARCH_SUCCESSMSG,'[ACTCUSTNAME]',CUSTOMER_NAME));
    END IF;
END IF;
IF EXISTS (SELECT UASD_ACCESS_CARD FROM UNIT_ACCESS_STAMP_DETAILS WHERE UASD_ACCESS_CARD=CARD_NO AND UASD_ACCESS_LOST IS NOT NULL) THEN
SET @LOST_CARD=(SELECT CONCAT('SELECT COUNT(*) INTO @LOSTCARD FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE ACN_ID IN (SELECT ACN_ID FROM ACCESS_CONFIGURATION WHERE ACN_ID!=4) AND UASD_ID=',CARD_ID,' AND CACD_VALID_TILL IS NOT NULL'));
PREPARE LOST_CARD_STMT FROM @LOST_CARD;
EXECUTE LOST_CARD_STMT;
SET LOSTCARD_CUSTOMER= @LOSTCARD;
IF LOSTCARD_CUSTOMER>1 THEN
		SET SEARCH_SUCCESSMSG='';
		SET @INSERT_TEMP_CUSTOMER_UNIT=(SELECT CONCAT('INSERT INTO ',TEMP_CUSTOMER_UNIT_LOST_CARD,'(CUSTOMERID) SELECT CUSTOMER_ID FROM CUSTOMER_ACCESS_CARD_DETAILS WHERE ACN_ID IN (SELECT ACN_ID FROM ACCESS_CONFIGURATION WHERE ACN_ID!=4) AND UASD_ID=',CARD_ID,' AND CACD_VALID_TILL IS NOT NULL'));
		PREPARE INSERT_TEMP_CUSTOMER_UNIT_STMT FROM @INSERT_TEMP_CUSTOMER_UNIT;
		EXECUTE INSERT_TEMP_CUSTOMER_UNIT_STMT;
		SET @MINID_LOSTCARD_CUSTOMER=(SELECT CONCAT('SELECT MIN(ID)INTO @MINID_LOST FROM ',TEMP_CUSTOMER_UNIT_LOST_CARD));
		PREPARE MINID_LOSTCARD_CUSTOMER_STMT FROM @MINID_LOSTCARD_CUSTOMER;
		EXECUTE MINID_LOSTCARD_CUSTOMER_STMT;
		SET MINID_LOSTCARD=@MINID_LOST;
		SET @MAXID_LOSTCARD_CUSTOMER=(SELECT CONCAT('SELECT MAX(ID)INTO @MAXID_LOST FROM ',TEMP_CUSTOMER_UNIT_LOST_CARD));
		PREPARE MAXID_LOSTCARD_CUSTOMER_STMT FROM @MAXID_LOSTCARD_CUSTOMER;
		EXECUTE MAXID_LOSTCARD_CUSTOMER_STMT;
		SET MAXID_LOSTCARD=@MAXID_LOST;
	WHILE (MAXID_LOSTCARD>=MINID_LOSTCARD) DO 
		SET @TEMP_CUSTOMER_NAME_LOST_CARD=(SELECT CONCAT('SELECT CONCAT (CUSTOMER_FIRST_NAME,'' '',CUSTOMER_LAST_NAME)AS CUSTOMERNAME INTO @TEMP_CUSTOMERNAME_LOST FROM CUSTOMER WHERE CUSTOMER_ID=(SELECT CUSTOMERID FROM ',TEMP_CUSTOMER_UNIT_LOST_CARD,' WHERE ID=',MINID_LOSTCARD,')'));
		PREPARE TEMP_CUSTOMER_NAME_LOST_CARD_STMT FROM @TEMP_CUSTOMER_NAME_LOST_CARD;
		EXECUTE TEMP_CUSTOMER_NAME_LOST_CARD_STMT;
		IF(MINID_LOSTCARD=1) THEN
			SET CUSTOMER_NAME_LOSTCARD=(SELECT CONCAT('',CUSTOMER_NAME_LOSTCARD,'',@TEMP_CUSTOMERNAME_LOST));
    ELSEIF (MINID_LOSTCARD!=1)THEN
			SET CUSTOMER_NAME_LOSTCARD=(SELECT CONCAT('',CUSTOMER_NAME_LOSTCARD,',',@TEMP_CUSTOMERNAME_LOST));
    END IF;
		  SET MINID_LOSTCARD=MINID_LOSTCARD+1;
  END WHILE;
      SET SEARCH_SUCCESSMSG=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=573);
      SET SEARCH_SUCCESSMSG=(SELECT REPLACE(SEARCH_SUCCESSMSG,'[CARD_NO]',CARD_NO));
      SET SEARCH_SUCCESSMSG=(SELECT REPLACE(SEARCH_SUCCESSMSG,'[ACTCUSTNAME]',CUSTOMER_NAME_LOSTCARD));
END IF;
END IF;
COMMIT;
END;