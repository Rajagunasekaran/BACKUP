-- VERSION 0.1 STARTDATE:26/06/2014 ENDDATE:26/06/2014 ISSUE NO: 593 DESC:THROWING ERROR MSG FOR THE CHECK CONSTRAINS. DONE BY :RAJA

DROP PROCEDURE IF EXISTS SP_TRG_BIZDLY_MOVING_IN_AND_OUT_VALIDATION;
CREATE PROCEDURE SP_TRG_BIZDLY_MOVING_IN_AND_OUT_VALIDATION(
IN NEWUNITID INTEGER,
IN NEWINVOICEDATE DATE,
IN PROCESS TEXT)
BEGIN
  DECLARE UNITSTARTDATE DATE;
  DECLARE UNITENDDATE DATE;
  DECLARE CONFIGENDDATE DATE;
  DECLARE MESSAGE_TEXT VARCHAR(50);

    -- CALL THE SP_CONFIG_MONTH FOR ENDDATE + CONFIG MONTH
    CALL SP_CONFIG_MONTH(NEWUNITID,@CONFIGDATE);
    SET CONFIGENDDATE=@CONFIGDATE;
    
    -- SELECT UNIT STARTDATE FROM UNIT DETAILS
    SET UNITSTARTDATE=(SELECT UD_START_DATE FROM UNIT_DETAILS WHERE UNIT_ID=NEWUNITID);

    -- THROWING ERROR MSG 
    IF(PROCESS = 'INSERT') OR (PROCESS='UPDATE')THEN  
		IF (NEWINVOICEDATE > CURDATE())THEN
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT= 'EMIO_INVOICE_DATE SHOULD BE LESSER THAN OR EQUEL TO TODAY DATE';
		END IF;

		IF(CONFIGENDDATE <= CURDATE())THEN
			SET UNITENDDATE=CONFIGENDDATE;
		ELSE
			SET UNITENDDATE = CURDATE();
		END IF;

		IF(NEWINVOICEDATE NOT BETWEEN UNITSTARTDATE AND UNITENDDATE)THEN
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT= 'EMIO_INVOICE_DATE SHOULD BE BETWEEN THE UNIT STARTDATE AND UNIT ENDDATE';
		END IF;
    END IF;
END;