DROP PROCEDURE IF EXISTS SP_LOGIN_CREATION_INSERT;
CREATE PROCEDURE SP_LOGIN_CREATION_INSERT
(LOGINID VARCHAR(40),
ROLENAME VARCHAR(15),
JOINDATE DATE,
USERSTAMP VARCHAR(50),
OUT UR_FLAG INTEGER)
BEGIN
DECLARE MINID INTEGER;
DECLARE MAXID INTEGER;
DECLARE RECVER INTEGER;
DECLARE ULDID INTEGER;
DECLARE USERSTAMP_ID INTEGER(2);
DECLARE TEMPTABLE_MENU TEXT;
DECLARE TEMPTBL_MENU TEXT;
DECLARE EPID INT;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
	ROLLBACK; 
	SET UR_FLAG=0;
END;
START TRANSACTION;
CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
SET USERSTAMP_ID = (SELECT @ULDID);
SET TEMPTBL_MENU=(SELECT CONCAT('TEMPTABLE_MENU',SYSDATE()));
SET TEMPTBL_MENU=(SELECT REPLACE(TEMPTBL_MENU,' ',''));
SET TEMPTBL_MENU=(SELECT REPLACE(TEMPTBL_MENU,'-',''));
SET TEMPTBL_MENU=(SELECT REPLACE(TEMPTBL_MENU,':',''));
SET TEMPTABLE_MENU=(SELECT CONCAT(TEMPTBL_MENU,'_',USERSTAMP_ID));
SET RECVER=(SELECT MAX(UA_REC_VER) FROM USER_ACCESS WHERE ULD_ID=(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=LOGINID));
SET ULDID=(SELECT DISTINCT ULD_ID FROM USER_ACCESS WHERE ULD_ID=(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=LOGINID));
IF NOT EXISTS(SELECT ULD_LOGINID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=LOGINID)THEN
	IF LOGINID IS NOT NULL THEN
		INSERT INTO USER_LOGIN_DETAILS(ULD_LOGINID,ULD_USERSTAMP)VALUES(LOGINID,USERSTAMP);
		SET UR_FLAG=1;
	END IF;
END IF;	
IF (LOGINID IS NOT NULL AND ROLENAME IS NOT NULL AND JOINDATE IS NOT NULL AND USERSTAMP IS NOT NULL)THEN
	IF (ULDID IS NOT NULL)THEN
		INSERT INTO USER_ACCESS(RC_ID,ULD_ID,UA_REC_VER,UA_JOIN_DATE,UA_JOIN,UA_USERSTAMP)VALUES((SELECT RC_ID FROM ROLE_CREATION WHERE RC_NAME=ROLENAME),
		(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=LOGINID),(RECVER+1),JOINDATE,'X',USERSTAMP);
		SET UR_FLAG=1;
	ELSE
		INSERT INTO USER_ACCESS(RC_ID,ULD_ID,UA_REC_VER,UA_JOIN_DATE,UA_JOIN,UA_USERSTAMP)VALUES((SELECT RC_ID FROM ROLE_CREATION WHERE RC_NAME=ROLENAME),
		(SELECT ULD_ID FROM USER_LOGIN_DETAILS WHERE ULD_LOGINID=LOGINID),1,JOINDATE,'X',USERSTAMP);
		SET UR_FLAG=1;
	END IF;   
END IF;
	SET @CREATE_TEMPTABLE_MENU=(SELECT CONCAT('CREATE TABLE ',TEMPTABLE_MENU,'(ID INTEGER PRIMARY KEY AUTO_INCREMENT,MP_ID INTEGER,EP_ID INTEGER)'));
  PREPARE CREATE_TEMPTABLE_MENU_STMT FROM @CREATE_TEMPTABLE_MENU;
  EXECUTE CREATE_TEMPTABLE_MENU_STMT;
	SET @INSERT_TEMPTABLE_MENU=(SELECT CONCAT('INSERT INTO ',TEMPTABLE_MENU,'(MP_ID,EP_ID) SELECT M.MP_ID,M.EP_ID FROM USER_MENU_DETAILS U,MENU_PROFILE M WHERE U.RC_ID=(SELECT RC_ID FROM ROLE_CREATION WHERE RC_NAME=','"',ROLENAME,'"',')AND U.MP_ID=M.MP_ID'));
	PREPARE INSERT_TEMPTABLE_MENU_STMT FROM @INSERT_TEMPTABLE_MENU;
  EXECUTE INSERT_TEMPTABLE_MENU_STMT;
	SET @MIN_ID=NULL;
  SET @SELECT_MINID=(SELECT CONCAT('SELECT MIN(ID) INTO @MIN_ID FROM ',TEMPTABLE_MENU));
  PREPARE SELECT_MINID_STMT FROM @SELECT_MINID;
  EXECUTE SELECT_MINID_STMT;
	SET MINID=@MIN_ID;
  SET @MAX_ID=NULL;
  SET @SELECT_MAXID=(SELECT CONCAT('SELECT MAX(ID) INTO @MAX_ID FROM ',TEMPTABLE_MENU));
  PREPARE SELECT_MAXID_STMT FROM @SELECT_MAXID;
  EXECUTE SELECT_MAXID_STMT;
	SET MAXID=@MAX_ID;
	WHILE (MINID<=MAXID)DO
    SET @T_EPID=NULL;
    SET @SELECT_EPID=(SELECT CONCAT('SELECT EP_ID INTO @T_EPID FROM ',TEMPTABLE_MENU,' WHERE ID=',MINID,' AND EP_ID IS NOT NULL'));
    PREPARE SELECT_EPID_STMT FROM @SELECT_EPID;
    EXECUTE SELECT_EPID_STMT;
    SET EPID=@T_EPID;
  	IF (EPID IS NOT NULL)THEN		
      SET @INSERT_EMAIL_LIST=(SELECT CONCAT('INSERT INTO EMAIL_LIST (EP_ID,EL_EMAIL_ID,ULD_ID)VALUES((SELECT EP_ID FROM ',TEMPTABLE_MENU,' WHERE ID=',MINID,'),','"',LOGINID,'"',',',USERSTAMP_ID,')'));
      PREPARE INSERT_EMAIL_LIST_STMT FROM @INSERT_EMAIL_LIST;
      EXECUTE INSERT_EMAIL_LIST_STMT;
      SET UR_FLAG=1;
		END IF;
		SET MINID=MINID+1;
	END WHILE;
  SET @DROP_TEMPTABLE_MENU=(SELECT CONCAT('DROP TABLE ',TEMPTABLE_MENU));
  PREPARE DROP_TEMPTABLE_MENU_STMT FROM @DROP_TEMPTABLE_MENU;
  EXECUTE DROP_TEMPTABLE_MENU_STMT;
COMMIT;
END;