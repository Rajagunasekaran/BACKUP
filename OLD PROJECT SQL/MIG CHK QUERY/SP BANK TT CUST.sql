DROP PROCEDURE IF EXISTS SP_MIG_BANK_TRANSFER_CUSTOMER;
CREATE PROCEDURE SP_MIG_BANK_TRANSFER_CUSTOMER(
IN DESTINATIONSCHEMA TEXT,
IN SOURCESCHEMA TEXT)
BEGIN
  DECLARE TEMP_BANK_TRANSFER TEXT;
  DECLARE TEMP_MIG_BANK_TRANSFER TEXT;
  DECLARE TEMP_CUST TEXT;
  DECLARE TEMP_CUSTNAME TEXT;
  DECLARE TEMP_FINAL_BANK TEXT;
  DECLARE CUSTLNAME TEXT;
  DECLARE CUSTFNAME TEXT;
  DECLARE MINID INTEGER;
	DECLARE MAXID INTEGER;
  DECLARE EXIT HANDLER FOR SQLEXCEPTION
  BEGIN
    ROLLBACK;
  END;
  -- TEMP TABLE ALL BANK TT CUSTOMER
  SET TEMP_CUST=(SELECT CONCAT('TEMP_CUSTOMER',SYSDATE()));
  SET TEMP_CUST=(SELECT REPLACE(TEMP_CUST,' ',''));
  SET TEMP_CUST=(SELECT REPLACE(TEMP_CUST,'-',''));
  SET TEMP_CUST=(SELECT REPLACE(TEMP_CUST,':',''));
  SET TEMP_CUSTNAME = TEMP_CUST;  
  SET @CREATE_TEMP_CUSTNAME=(SELECT CONCAT('CREATE TABLE ',TEMP_CUSTNAME,'(BT_SNO INT,UNIT_NO INT,BT_CUSTOMER VARCHAR(50))'));
  PREPARE CREATE_TEMP_CUSTNAME_STMT FROM @CREATE_TEMP_CUSTNAME;
  EXECUTE CREATE_TEMP_CUSTNAME_STMT;
  SET @INSERT_TEMP_CUSTNAME=(SELECT CONCAT('INSERT INTO ',TEMP_CUSTNAME,'(BT_SNO ,UNIT_NO, BT_CUSTOMER) (SELECT BT_SNO, BT_UNIT, BT_CUSTOMER  FROM ',SOURCESCHEMA,'.MIG_BANK_TRANSFER WHERE BT_CUSTOMER IS NOT NULL AND BT_UNIT IS NOT NULL )'));
  PREPARE INSERT_TEMP_CUSTNAME_STMT FROM @INSERT_TEMP_CUSTNAME;
  EXECUTE INSERT_TEMP_CUSTNAME_STMT;
  -- DELETE 3 CUSTOMER NAMES
  SET @DELETE_TEMP_CUSTNAME=( SELECT CONCAT('DELETE FROM ',TEMP_CUSTNAME,' WHERE BT_CUSTOMER='"'MAUNG KHIN MAUNG WIN'"' OR BT_CUSTOMER='"'RIN NAN YOONG'"' OR BT_CUSTOMER='"'LEONG KIAN SHIANG'"));
  PREPARE DELETE_TEMP_CUSTNAME FROM @DELETE_TEMP_CUSTNAME; 
  EXECUTE DELETE_TEMP_CUSTNAME;
  -- UPDATE CUSTOMER NAMES
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'ALI'"' WHERE BT_CUSTOMER='"'ALI YILMAZ'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'HANA'"' WHERE BT_CUSTOMER='"'JOO HANA'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'YANIV'"' WHERE BT_CUSTOMER='"'YANIV GODER'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'VICKY CULLEN'"' WHERE BT_CUSTOMER='"'YANG MING'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'DAIMLER MARI OGASA'"' WHERE BT_CUSTOMER='"'MARI OGASA'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'ZUBIN'"' WHERE BT_CUSTOMER='"'NAVIN C. SHARMA AND PAMELA MORIN'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'SALMA'"' WHERE BT_CUSTOMER='"'SAIMA'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'AKIMA'"' WHERE BT_CUSTOMER='"'AKM PRINCIPAL INVESTMENTS PTE LTD'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'DAVIS AND OLIVIA'"' WHERE BT_CUSTOMER='"'OLIVIA'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'BENJAMIN'"' WHERE BT_CUSTOMER='"'BENJAMIN AARON GILLENWATER'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'SILVIU BUSU'"' WHERE BT_CUSTOMER='"'ARISTOTEL SILVIU BUSU LUNCAR'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'JUNE WANG'"' WHERE BT_CUSTOMER='"'WANG JUNXIA'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'VALLARINO'"' WHERE BT_CUSTOMER='"'VITTORIO VALLARINO GANCIA'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'LILLIAN WONG'"' WHERE BT_CUSTOMER='"'LILLIAN CHIA LING WANG'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'MAN'"' WHERE BT_CUSTOMER='"'CHAN LAI MAN'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'YOKO'"' WHERE BT_CUSTOMER='"'PLENUS & MK PTE LTD'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'BW FLEET'"' WHERE BT_CUSTOMER='"'BW MARITIME PTE LTD'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'HAITHAM'"' WHERE BT_CUSTOMER='"'HAITHAM A H M ABDULKARIM'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'PONTUS'"' WHERE BT_CUSTOMER='"'SIGHTLINE VISION AB'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'FARHANA'"' WHERE BT_CUSTOMER='"'ALAN ZACHARY ANWAR'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'CATHERINE'"' WHERE BT_CUSTOMER='"'CAITLIN JEAN WONG'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'CHRIS'"' WHERE BT_CUSTOMER='"'CHRIS CHEN'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'ROSALIND CHU'"' WHERE BT_CUSTOMER='"'ROSALIND ANNETT CHU'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'MATTHIAS AND CAITILN TILP'"' WHERE BT_CUSTOMER='"'MATTHIAS AND CAITILN'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'LISA MAHTANI'"' WHERE BT_CUSTOMER='"'LISA'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'CHRISTO WIESE'"' WHERE BT_CUSTOMER='"'CHRISTO'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'ANDREJ DOBES'"' WHERE BT_CUSTOMER='"'ANDREJ'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'ALEXANDER BRUNOW'"' WHERE BT_CUSTOMER='"'ALEX BRUNOW'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'RICHARD  WAINWRIGHT'"' WHERE BT_CUSTOMER='"'RICHARD WAINWRIGHT'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'CIARON PATRICK MCKINLEY'"' WHERE BT_CUSTOMER='"'CIARON'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'EASON FANG ENHUA'"' WHERE BT_CUSTOMER='"'EASON'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'VENN ILIEV SALTIROV'"' WHERE BT_CUSTOMER='"'VENN'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'SHUBHAM CHANDRA'"' WHERE BT_CUSTOMER='"'SHUBHAM CHANDHRA'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @UPDATE_TEMP_CUSTNAME=(SELECT CONCAT('UPDATE ',TEMP_CUSTNAME,' SET BT_CUSTOMER='"'ELAINE PATERSON'"' WHERE BT_CUSTOMER='"'ELLEN PATERSON'"));
  PREPARE UPTEMP_CUSTNAME FROM @UPDATE_TEMP_CUSTNAME;
  EXECUTE UPTEMP_CUSTNAME;
  SET @TEMPCUSTOMER=(SELECT CONCAT('CREATE TABLE TEMPCUSTOMER (ID INTEGER AUTO_INCREMENT PRIMARY KEY, NAME VARCHAR(50),CUSTID INTEGER)'));
  PREPARE TEMPCUSTOMER_STMT FROM @TEMPCUSTOMER;
	EXECUTE TEMPCUSTOMER_STMT;	
  SET @INSERT_TEMPCUSTOMER=(SELECT CONCAT('INSERT INTO TEMPCUSTOMER (NAME,CUSTID)(SELECT CC_FIRST_NAME,CC_CUST_ID FROM ',SOURCESCHEMA,'.CUSTOMER_SCDB_FORMAT WHERE CC_FIRST_NAME=CC_LAST_NAME)'));
  PREPARE INSERT_TEMPCUSTOMER_STMT FROM @INSERT_TEMPCUSTOMER;
  EXECUTE INSERT_TEMPCUSTOMER_STMT;  
  SET @MIN_ID = (SELECT CONCAT('SELECT MIN(ID) INTO @MINIMUMID FROM TEMPCUSTOMER'));
	PREPARE MIN_ID_STMT FROM @MIN_ID;
	EXECUTE MIN_ID_STMT;	
	SET @MAX_ID = (SELECT CONCAT('SELECT MAX(ID) INTO @MAXIMUMID FROM TEMPCUSTOMER'));
	PREPARE MAX_ID_STMT FROM @MAX_ID;
	EXECUTE MAX_ID_STMT;	
	SET MINID = @MINIMUMID;
	SET MAXID = @MAXIMUMID;  
  WHILE (MINID <= MAXID) DO
    SET @FCUSTNAME=(SELECT CONCAT('SELECT CC_FIRST_NAME,CC_LAST_NAME INTO @CUSTFNAME,@CUSTLNAME FROM ',SOURCESCHEMA,'.CUSTOMER_SCDB_FORMAT WHERE CC_CUST_ID=(SELECT CUSTID FROM TEMPCUSTOMER WHERE ID=',MINID,')'));
    PREPARE FCUSTNAME_STMT FROM @FCUSTNAME;
    EXECUTE FCUSTNAME_STMT;  
    SET CUSTFNAME= @CUSTFNAME;
    SET CUSTLNAME= @CUSTLNAME;  
    DROP TABLE IF EXISTS TEMP_FINAL_CUSTOMER;
    SET @CREATE_TEMP_MIG_BANK_TRANSFER=(SELECT CONCAT('CREATE TABLE TEMP_FINAL_CUSTOMER (BT_SNO INTEGER, UNIT_ID INTEGER, UNIT_NO INTEGER, CC_UNIT_NO INT, BT_CUSTOMER VARCHAR(50), CUST_ID INTEGER)'));
    PREPARE CREATE_TEMP_MIG_BANK_TRANSFER_STMT FROM @CREATE_TEMP_MIG_BANK_TRANSFER;
    EXECUTE CREATE_TEMP_MIG_BANK_TRANSFER_STMT;  
    SET @INSERT_FINAL_CUSTNAME=(SELECT CONCAT('INSERT INTO TEMP_FINAL_CUSTOMER (BT_SNO,UNIT_ID,UNIT_NO,CC_UNIT_NO,BT_CUSTOMER,CUST_ID) (SELECT BT.BT_SNO, U.UNIT_ID ,BT.UNIT_NO,CSF.CC_UNIT_NO,BT.BT_CUSTOMER,CSF.CC_CUST_ID
    FROM ',TEMP_CUSTNAME,' BT  INNER JOIN ',SOURCESCHEMA,'.CUSTOMER_SCDB_FORMAT CSF  INNER JOIN ',DESTINATIONSCHEMA,'.UNIT U ON  BT.UNIT_NO=U.UNIT_NO AND CSF.CC_UNIT_NO=U.UNIT_NO
    WHERE (BT.UNIT_NO=CSF.CC_UNIT_NO AND BT.BT_CUSTOMER=CONCAT(CSF.CC_FIRST_NAME,'' '', CSF.CC_LAST_NAME)) OR (BT.UNIT_NO=CSF.CC_UNIT_NO AND BT.BT_CUSTOMER=CSF.CC_FIRST_NAME AND CSF.CC_LAST_NAME IS NULL ) GROUP BY BT.BT_SNO)'));
    PREPARE INSERT_FINAL_CUSTNAME_STMT FROM @INSERT_FINAL_CUSTNAME;
    EXECUTE INSERT_FINAL_CUSTNAME_STMT;  
    IF (CUSTFNAME=CUSTLNAME) THEN
      SET @INSERT_FINAL_CUSTNAME=(SELECT CONCAT('INSERT INTO TEMP_FINAL_CUSTOMER (BT_SNO,UNIT_ID,UNIT_NO,CC_UNIT_NO,BT_CUSTOMER,CUST_ID) (SELECT BT.BT_SNO, U.UNIT_ID ,BT.UNIT_NO,CSF.CC_UNIT_NO,BT.BT_CUSTOMER,CSF.CC_CUST_ID
      FROM ',TEMP_CUSTNAME,' BT  INNER JOIN ',SOURCESCHEMA,'.CUSTOMER_SCDB_FORMAT CSF  INNER JOIN ',DESTINATIONSCHEMA,'.UNIT U ON  BT.UNIT_NO=U.UNIT_NO AND CSF.CC_UNIT_NO=U.UNIT_NO
      WHERE (BT.UNIT_NO=CSF.CC_UNIT_NO AND CSF.CC_FIRST_NAME=BT.BT_CUSTOMER AND CSF.CC_LAST_NAME=BT.BT_CUSTOMER) GROUP BY BT.BT_SNO)'));
      PREPARE INSERT_FINAL_CUSTNAME_STMT FROM @INSERT_FINAL_CUSTNAME;
      EXECUTE INSERT_FINAL_CUSTNAME_STMT;
    END IF;
    SET MINID = MINID+1;
  END WHILE;
  SET @DROP_TEMP_CUSTNAME=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_CUSTNAME));
	PREPARE DROP_TEMP_CUSTNAME_STMT FROM @DROP_TEMP_CUSTNAME;
	EXECUTE DROP_TEMP_CUSTNAME_STMT;
  DROP TABLE IF EXISTS TEMPCUSTOMER;
  COMMIT;
END;
/*
CALL SP_MIG_BANK_TRANSFER_CUSTOMER ('DEST_12072014','SOURCE_12072014');
SELECT *FROM TEMP_FINAL_CUSTOMER;
*/