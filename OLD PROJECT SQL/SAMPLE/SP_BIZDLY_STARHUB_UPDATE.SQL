DROP PROCEDURE IF EXISTS SP_BIZDLY_STARHUB_UPDATE;
CREATE PROCEDURE SP_BIZDLY_STARHUB_UPDATE(
IN ESHID INTEGER,
IN INVOICE_DATE DATE,
IN FROM_PERIOD DATE,
IN TO_PERIOD DATE,
IN AMOUNT DECIMAL(7,2),
IN COMMENTS TEXT,
IN USERSTAMP VARCHAR(50),
OUT OUTPUT_MSG TEXT)
BEGIN
DECLARE ECNID TEXT;
DECLARE EDSHID TEXT;
DECLARE USERSTAMP_ID INTEGER(2);
DECLARE YEAR_INVDATE INTEGER;
DECLARE MONTHNAME VARCHAR(20);
DECLARE MONTH_YEAR VARCHAR(25);
DECLARE OLDINVDATE DATE;
DECLARE ERRORMSG TEXT;
DECLARE MONTH_INVDATE INTEGER;
DECLARE TODAYDATE DATE;
DECLARE UNITID INTEGER;
DECLARE UNITSTARTDATE DATE;
DECLARE UNITMONTH INTEGER;
DECLARE MINDATE DATE;
DECLARE MAXDATE DATE;
DECLARE UNITENDDATE DATE;
DECLARE SHUBUNITNO INTEGER(4) UNSIGNED ZEROFILL;
DECLARE TO_PERIOD_ENDDATE DATE;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN 
ROLLBACK; 
SET OUTPUT_MSG=0;
END;
SET AUTOCOMMIT=0;
SET MONTH_INVDATE=(SELECT MONTH(INVOICE_DATE));
SET YEAR_INVDATE=(SELECT YEAR(INVOICE_DATE));
SET MONTHNAME=(SELECT UCASE(MONTHNAME(STR_TO_DATE(MONTH_INVDATE, '%m'))));
SET MONTH_YEAR=(SELECT CONCAT(MONTHNAME,'-',YEAR_INVDATE));
SET ERRORMSG=(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=472);
SET UNITID=(SELECT UNIT_ID FROM EXPENSE_DETAIL_STARHUB WHERE EDSH_ID=(SELECT EDSH_ID FROM EXPENSE_STARHUB WHERE ESH_ID=ESHID));
SET SHUBUNITNO=(SELECT UNIT_NO FROM UNIT WHERE UNIT_ID=UNITID);
SET ERRORMSG=(SELECT REPLACE(ERRORMSG,'[UNITNO]',SHUBUNITNO));
SET ERRORMSG=(SELECT REPLACE(ERRORMSG,'[MONTH]',MONTH_YEAR));
SET TO_PERIOD_ENDDATE=(SELECT DATE_ADD(FROM_PERIOD,INTERVAL 2 MONTH));
SET TO_PERIOD_ENDDATE=(SELECT LAST_DAY(TO_PERIOD_ENDDATE));
CALL SP_CONFIG_SDATE_EDATE(UNITID,@S_CONFIGDATE,@E_CONFIGDATE,@INVOICE_DATE);
SET UNITSTARTDATE=@S_CONFIGDATE;
SET UNITENDDATE=@E_CONFIGDATE;
SET MAXDATE=@INVOICE_DATE;
SET TODAYDATE=CURDATE();
SET OUTPUT_MSG=' ';
IF (INVOICE_DATE>TODAYDATE) THEN
    SET OUTPUT_MSG=(SELECT CONCAT(OUTPUT_MSG,',',(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=474)));
END IF;
SET MINDATE=UNITSTARTDATE;
IF TO_PERIOD_ENDDATE>UNITENDDATE THEN
SET TO_PERIOD_ENDDATE=UNITENDDATE;
END IF;
IF INVOICE_DATE NOT BETWEEN MINDATE AND MAXDATE THEN 
    SET OUTPUT_MSG=(SELECT CONCAT(OUTPUT_MSG,',',(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=475)));
END IF;
IF FROM_PERIOD NOT BETWEEN MINDATE AND UNITENDDATE THEN
    SET OUTPUT_MSG=(SELECT CONCAT(OUTPUT_MSG,',',(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=476)));
END IF;
IF TO_PERIOD NOT BETWEEN FROM_PERIOD AND TO_PERIOD_ENDDATE THEN
    SET OUTPUT_MSG=(SELECT CONCAT(OUTPUT_MSG,',',(SELECT EMC_DATA FROM ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=477)));
END IF;
IF EXISTS(SELECT * FROM EXPENSE_STARHUB WHERE MONTH(ESH_INVOICE_DATE)=MONTH_INVDATE AND YEAR(ESH_INVOICE_DATE)=YEAR_INVDATE AND EDSH_ID IN(SELECT EDSH_ID FROM EXPENSE_DETAIL_STARHUB WHERE UNIT_ID=UNITID)AND ESH_ID!=ESHID)THEN
SET OUTPUT_MSG=(SELECT CONCAT(OUTPUT_MSG,',',ERRORMSG));
END IF;
SET OUTPUT_MSG=(SELECT SUBSTRING(OUTPUT_MSG,3));
	IF(INVOICE_DATE='' OR INVOICE_DATE IS NULL)THEN
		SET INVOICE_DATE = NULL;
	END IF;
	IF(FROM_PERIOD='' OR FROM_PERIOD IS NULL)THEN
		SET FROM_PERIOD = NULL;
	END IF;
	IF(TO_PERIOD='' OR TO_PERIOD IS NULL)THEN
		SET TO_PERIOD = NULL;
	END IF;
	IF(AMOUNT='' OR AMOUNT IS NULL)THEN
		SET AMOUNT = NULL;
	END IF;
	IF(COMMENTS='' OR COMMENTS IS NULL)THEN
		SET COMMENTS = NULL;
	END IF;
	IF(USERSTAMP='' OR USERSTAMP IS NULL)THEN
		SET USERSTAMP = NULL;
	END IF;
START TRANSACTION;
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
    SET USERSTAMP_ID = (SELECT @ULDID);
	IF(INVOICE_DATE IS NOT NULL AND FROM_PERIOD IS NOT NULL AND TO_PERIOD IS NOT NULL AND USERSTAMP IS NOT NULL) THEN  
			IF OUTPUT_MSG=' ' THEN
				UPDATE EXPENSE_STARHUB SET ESH_INVOICE_DATE=INVOICE_DATE,ESH_FROM_PERIOD=FROM_PERIOD,ESH_TO_PERIOD=TO_PERIOD,ESH_AMOUNT=AMOUNT,ESH_COMMENTS=COMMENTS,ULD_ID=USERSTAMP_ID WHERE ESH_ID=ESHID;
			SET OUTPUT_MSG=1;
			END IF;
		END IF;
COMMIT;
END;