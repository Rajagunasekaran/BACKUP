-- version:0.2 --sdate:08-07-2014 --edate:08-07-2014 --issue:593 --commentno#245 --desc:CHANGES IN SP FOR CGN_ID INSTEAD OF CGN_DATA --doneby:BHAVANI.R
-- version:0.1 --sdate:25-06-2014 --edate:25-06-2014 --issue:593 --commentno#75 --desc:SP FOR CALCULATING CONFIG MONTH --doneby:DHIVYA

DROP PROCEDURE IF EXISTS SP_CONFIG_STARTDATE;
CREATE PROCEDURE SP_CONFIG_STARTDATE(
IN UNITID INTEGER,
OUT CONFIGDATE DATE
)
BEGIN
DECLARE UNITMONTH INTEGER;
DECLARE UNIT_MONTH INTEGER;
DECLARE UNITSDATE DATE;
DECLARE STARTDATE DATE;
DECLARE CONFIG_YEAR INTEGER;
DECLARE CONFIG_MONTH INTEGER;
DECLARE CONFIG_DAY INTEGER;
DECLARE CONFIGMONTH INTEGER;
SET UNITSDATE=(SELECT UD_START_DATE FROM UNIT_DETAILS WHERE UNIT_ID=UNITID);
SET STARTDATE=UNITSDATE;
SET UNITMONTH=(SELECT ECN_DATA FROM EXPENSE_CONFIGURATION WHERE ECN_ID=201);
SET UNIT_MONTH=0;
WHILE UNIT_MONTH<=UNITMONTH DO
	SET CONFIGDATE=(SELECT DATE_SUB(UNITSDATE,INTERVAL 1 MONTH));
	IF UNIT_MONTH<UNITMONTH THEN
			SET CONFIGDATE=(SELECT LAST_DAY(CONFIGDATE));
			SET UNITSDATE=CONFIGDATE;
		END IF;
		IF UNIT_MONTH=UNITMONTH THEN
			SET CONFIG_YEAR=(SELECT YEAR(UNITSDATE));
			SET CONFIG_MONTH=(SELECT MONTH(UNITSDATE));
			SET CONFIG_DAY=(SELECT DAY(STARTDATE));
			SET CONFIGMONTH=(SELECT MONTH(STARTDATE));
			IF LENGTH(CONFIG_MONTH)=1 THEN
			SET CONFIG_MONTH=(SELECT CONCAT('0',CONFIG_MONTH));
			END IF;
			IF LENGTH(CONFIG_DAY)=1 THEN
			SET CONFIG_DAY=(SELECT CONCAT('0',CONFIG_DAY));
			END IF;
			IF (CONFIG_DAY=31) OR (CONFIG_DAY=30) THEN
			SET CONFIGDATE=(SELECT LAST_DAY(UNITSDATE));
			ELSE
			SET CONFIGDATE=(SELECT CONCAT(CONFIG_YEAR,'-',CONFIG_MONTH,'-',CONFIG_DAY));
			END IF;
		END IF;
	SET UNIT_MONTH=UNIT_MONTH+1;
END WHILE;
END;