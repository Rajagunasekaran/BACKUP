DROP PROCEDURE IF EXISTS SP_UNIT_CREATION_INSERT;
CREATE PROCEDURE SP_UNIT_CREATION_INSERT(
IN UNIT_NUMBER SMALLINT(4),
IN UNIT_PAYMENT SMALLINT(4),
IN START_DATE DATE,
IN END_DATE DATE,
IN NON_EI CHAR(1),
IN UNIT_DEPOSIT INT(5),
IN USERSTAMP VARCHAR(50),
IN ACCESS_CARD INTEGER(7),
IN ROOMTYPE VARCHAR(30),
IN STAMP_DUTY_DATE DATE,
IN STAMPDUTYTPYE CHAR(12),
IN STAMP_DUTY_AMOUNT DECIMAL(6,2),
IN COMMENTS TEXT,
IN DOOR_CODE VARCHAR(10),
IN WEB_LOGIN VARCHAR(20),
IN WEB_PASSWORD VARCHAR(6),
IN ACCOUNT_NUMBER VARCHAR(15),
IN ACCOUNT_NAME VARCHAR(25),
IN BANK_CODE VARCHAR(5),
IN BRANCH_CODE VARCHAR(5),
IN BANK_ADDRESS VARCHAR(250),
OUT UNITCREATION_FLAG INTEGER)
BEGIN
  DECLARE ROOM_TYPE INT;
	DECLARE STAMP_DUTY_TYPE INT;
	DECLARE STATUS INT(1) DEFAULT 0;
	DECLARE USERSTAMP_ID INTEGER(2);
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN 
		ROLLBACK; 
	END;
	IF NON_EI='' THEN
		SET NON_EI=NULL;
	END IF;
	IF UNIT_DEPOSIT='' THEN 
		SET UNIT_DEPOSIT=NULL;
	END IF;
	IF ACCOUNT_NUMBER='' THEN
		SET ACCOUNT_NUMBER=NULL;
	END IF;
	IF ACCOUNT_NAME='' THEN
		SET ACCOUNT_NAME=NULL;
	END IF;
	IF BANK_CODE='' THEN
		SET BANK_CODE=NULL;
	END IF;
	IF BRANCH_CODE='' THEN
		SET BRANCH_CODE=NULL;
	END IF;
	IF BANK_ADDRESS='' THEN
		SET BANK_ADDRESS=NULL;
	END IF;
	IF ACCESS_CARD='' THEN 
		SET ACCESS_CARD=NULL;
	END IF;
	IF ROOMTYPE='' OR ROOMTYPE=NULL THEN
		SET ROOMTYPE=NULL;
	END IF;
	IF STAMPDUTYTPYE='' OR STAMPDUTYTPYE=NULL THEN 
		SET STAMPDUTYTPYE=NULL;
	END IF;
	IF COMMENTS='' THEN
		SET COMMENTS=NULL;
	END IF;
	IF WEB_LOGIN=''THEN
		SET WEB_LOGIN=NULL;
	END IF;
	IF WEB_PASSWORD='' THEN
		SET WEB_PASSWORD=NULL;
	END IF;
	IF DOOR_CODE='' THEN
		SET DOOR_CODE=NULL;
	END IF;
	START TRANSACTION;
	SET UNITCREATION_FLAG=0;
	CALL SP_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULDID);
	SET USERSTAMP_ID = (SELECT @ULDID);
	IF(UNIT_NUMBER IS NOT NULL AND UNIT_PAYMENT IS NOT NULL AND START_DATE IS NOT NULL AND END_DATE IS NOT NULL) THEN
		IF(START_DATE <= END_DATE)THEN
			SET STATUS = 2;
		ELSE
			SET STATUS = 0;
		END IF;
		IF(STATUS =2)THEN
			INSERT INTO UNIT (UNIT_NO) VALUES(UNIT_NUMBER);
		END IF;
		IF(STATUS = 2)THEN
			INSERT INTO UNIT_DETAILS(UNIT_ID,UD_START_DATE,UD_END_DATE,UD_PAYMENT,UD_DEPOSIT,ULD_ID,UD_NON_EI,UD_COMMENTS)
      VALUES((SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER),START_DATE ,END_DATE,UNIT_PAYMENT,UNIT_DEPOSIT,USERSTAMP_ID,NON_EI,COMMENTS);
			SET UNITCREATION_FLAG = 1; 
		ELSE
			SET UNITCREATION_FLAG = 0;
		END IF;
	END IF;
	IF(STATUS =2)THEN
		IF ROOMTYPE IS NOT NULL THEN
			IF EXISTS(SELECT URTD_ROOM_TYPE FROM UNIT_ROOM_TYPE_DETAILS WHERE URTD_ROOM_TYPE=ROOMTYPE) THEN
				SET ROOM_TYPE = (SELECT URTD_ID FROM UNIT_ROOM_TYPE_DETAILS WHERE URTD_ROOM_TYPE=ROOMTYPE);
			END IF;
			IF NOT EXISTS(SELECT URTD_ROOM_TYPE FROM UNIT_ROOM_TYPE_DETAILS WHERE URTD_ROOM_TYPE=ROOMTYPE) THEN
				INSERT INTO UNIT_ROOM_TYPE_DETAILS (URTD_ROOM_TYPE, ULD_ID) VALUES (ROOMTYPE, USERSTAMP_ID);
				SET UNITCREATION_FLAG=1;
				SET ROOM_TYPE = (SELECT URTD_ID FROM UNIT_ROOM_TYPE_DETAILS WHERE URTD_ROOM_TYPE=ROOMTYPE);
			END IF;
		END IF;
	END IF;
	IF(STATUS = 2) THEN
		IF STAMPDUTYTPYE IS NOT NULL THEN
			IF EXISTS(SELECT USDT_DATA FROM UNIT_STAMP_DUTY_TYPE WHERE USDT_DATA=STAMPDUTYTPYE) THEN
				SET STAMP_DUTY_TYPE = (SELECT USDT_ID FROM UNIT_STAMP_DUTY_TYPE WHERE USDT_DATA=STAMPDUTYTPYE);
			END IF;
			IF NOT EXISTS(SELECT USDT_DATA FROM UNIT_STAMP_DUTY_TYPE WHERE USDT_DATA=STAMPDUTYTPYE) THEN
				INSERT INTO UNIT_STAMP_DUTY_TYPE (USDT_DATA, ULD_ID) VALUES (STAMPDUTYTPYE, USERSTAMP_ID);
				SET UNITCREATION_FLAG=1;
				SET STAMP_DUTY_TYPE = (SELECT USDT_ID FROM UNIT_STAMP_DUTY_TYPE WHERE USDT_DATA=STAMPDUTYTPYE);
			END IF;
		END IF;
	END IF;
	IF(STATUS =2)THEN
		IF(ACCESS_CARD IS NULL AND ( ROOM_TYPE IS NOT NULL OR STAMP_DUTY_DATE IS NOT NULL OR  STAMP_DUTY_TYPE IS NOT NULL OR STAMP_DUTY_AMOUNT IS NOT NULL)) THEN
			INSERT INTO UNIT_ACCESS_STAMP_DETAILS(UNIT_ID,UASD_ACCESS_CARD,URTD_ID,UASD_STAMPDUTYDATE,USDT_ID,UASD_STAMPDUTYAMT,ULD_ID)
			VALUES((SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER),ACCESS_CARD,ROOM_TYPE,STAMP_DUTY_DATE,STAMP_DUTY_TYPE,STAMP_DUTY_AMOUNT,USERSTAMP_ID);
			SET UNITCREATION_FLAG=1;
		END IF;
	END IF;
	IF(STATUS = 2)THEN
		IF(ACCESS_CARD IS NOT NULL)THEN
			INSERT INTO UNIT_ACCESS_STAMP_DETAILS(UNIT_ID,UASD_ACCESS_CARD,URTD_ID,UASD_STAMPDUTYDATE,USDT_ID,UASD_STAMPDUTYAMT,ULD_ID,UASD_ACCESS_INVENTORY)
			VALUES((SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER),ACCESS_CARD,ROOM_TYPE,STAMP_DUTY_DATE,STAMP_DUTY_TYPE,STAMP_DUTY_AMOUNT,USERSTAMP_ID,'X');
			SET UNITCREATION_FLAG=1;
		END IF;
	END IF;
	IF(STATUS = 2)THEN
		IF (DOOR_CODE IS NOT NULL OR WEB_LOGIN IS NOT NULL OR WEB_PASSWORD IS NOT NULL ) THEN
			INSERT INTO UNIT_LOGIN_DETAILS(UNIT_ID,ULDTL_DOORCODE,ULDTL_WEBLOGIN,ULDTL_WEBPWD,ULD_ID)VALUES((SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER), DOOR_CODE,WEB_LOGIN,WEB_PASSWORD,USERSTAMP_ID);
			SET UNITCREATION_FLAG=1;
		END IF;
	END IF;
	IF(STATUS = 2)THEN
		IF(ACCOUNT_NUMBER IS NOT NULL OR ACCOUNT_NAME IS NOT NULL OR BANK_CODE IS NOT NULL OR BRANCH_CODE IS NOT NULL OR BANK_ADDRESS IS NOT NULL ) THEN
			INSERT INTO UNIT_ACCOUNT_DETAILS(UNIT_ID,UACD_ACC_NO,UACD_ACC_NAME,UACD_BANK_CODE,UACD_BRANCH_CODE,UACD_BANK_ADDRESS)VALUES((SELECT UNIT_ID FROM UNIT WHERE UNIT_NO=UNIT_NUMBER),ACCOUNT_NUMBER,ACCOUNT_NAME,BANK_CODE,BRANCH_CODE,BANK_ADDRESS);
			SET UNITCREATION_FLAG=1;
		END IF;
	END IF;
COMMIT ;
END;