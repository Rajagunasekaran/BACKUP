DROP PROCEDURE IF EXISTS SP_CONFIG_ENDDATE;
CREATE PROCEDURE SP_CONFIG_ENDDATE(
IN UNITID INTEGER,
OUT CONFIGDATE DATE
)
BEGIN
DECLARE UNITMONTH INTEGER;
DECLARE UNIT_MONTH INTEGER;
DECLARE UNITEDATE DATE;
DECLARE ENDDATE DATE;
DECLARE CONFIG_YEAR INTEGER;
DECLARE CONFIG_MONTH INTEGER;
DECLARE CONFIG_DAY INTEGER;
DECLARE DATEFORMAT TEXT;
DECLARE CONFIGMONTH INTEGER;
SET UNITEDATE=(SELECT UD_END_DATE FROM UNIT_DETAILS WHERE UNIT_ID=UNITID);
SET ENDDATE=UNITEDATE;
SET UNITMONTH=(SELECT ECN_DATA FROM EXPENSE_CONFIGURATION WHERE ECN_ID=200);
SET UNIT_MONTH=0;
WHILE UNIT_MONTH<=UNITMONTH DO
	SET CONFIGDATE=(SELECT DATE_ADD(UNITEDATE,INTERVAL 1 MONTH));
		IF UNIT_MONTH<UNITMONTH THEN
			SET CONFIGDATE=(SELECT LAST_DAY(CONFIGDATE));
			SET UNITEDATE=CONFIGDATE;
		END IF;
		IF UNIT_MONTH=UNITMONTH THEN
			SET CONFIG_YEAR=(SELECT YEAR(UNITEDATE));
			SET CONFIG_MONTH=(SELECT MONTH(UNITEDATE));
			SET CONFIG_DAY=(SELECT DAY(ENDDATE));
			SET CONFIGMONTH=(SELECT MONTH(ENDDATE));
			IF LENGTH(CONFIG_MONTH)=1 THEN
			SET CONFIG_MONTH=(SELECT CONCAT('0',CONFIG_MONTH));
			END IF;
			IF LENGTH(CONFIG_DAY)=1 THEN
			SET CONFIG_DAY=(SELECT CONCAT('0',CONFIG_DAY));
			END IF;
			IF (CONFIG_DAY=31) OR (CONFIG_DAY=30) THEN
			SET CONFIGDATE=(SELECT LAST_DAY(UNITEDATE));
			ELSE
			SET CONFIGDATE=(SELECT CONCAT(CONFIG_YEAR,'-',CONFIG_MONTH,'-',CONFIG_DAY));
			END IF;
			-- IF ((CONFIG_DAY=29)OR (CONFIG_DAY=28)) AND (CONFIGMONTH=2) THEN
				-- SET CONFIGDATE=(SELECT LAST_DAY(UNITEDATE));
			-- END IF;
		END IF;
		SET UNIT_MONTH=UNIT_MONTH+1;
END WHILE;
END;